<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/colorful.css">
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/style.css">
    <link rel="shortcut icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>Openresty - Uxun's WIKI</title>
    <meta name="keywords" content=""/>
    <meta name="description" content=""/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
  </head>

  <body>
    <div id="container" class="typo">
      
<div id="header">
  <div id="post-nav">
    <a href="/wiki/">Uxun's WIKI</a>
    &nbsp;&#187;&nbsp;
    <a href="/wiki/#web">web</a>
    &nbsp;&#187;&nbsp;Openresty
    <span class="updated">Page Updated&nbsp;
    2019-08-21 13:00
    </span>
  </div>
</div>
<div class="clearfix"></div>
<div id="content">
  <h1 id="openresty-deploy">Openresty Deploy</h1>
<h3 id="concept"><a href="https://jusene.github.io/2019/05/26/openresty/">Concept</a></h3>
<h2 id="1repo-install">1.Repo Install</h2>
<p><a href="http://openresty.org/en/linux-packages.html">Linux Install Packages</a></p>
<div class="hlcode"><pre><span class="n">yum</span> <span class="n">install</span> <span class="n">yum</span><span class="o">-</span><span class="n">utils</span>
<span class="n">yum</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="n">manager</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">repo</span> <span class="n">https</span><span class="o">:</span><span class="c1">//openresty.org/package/centos/openresty.repo</span>

<span class="n">yum</span> <span class="n">install</span> <span class="n">openresty</span>
<span class="n">yum</span> <span class="n">install</span> <span class="n">openresty</span><span class="o">-</span><span class="n">resty</span>
</pre></div>


<hr />
<h2 id="2source-compile">2.Source Compile</h2>
<p><strong>1.prepare</strong></p>
<div class="hlcode"><pre><span class="n">yum</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">pcre</span><span class="o">-</span><span class="n">devel</span> <span class="n">openssl</span><span class="o">-</span><span class="n">devel</span> <span class="n">gcc</span> <span class="n">curl</span> <span class="n">postgresql</span><span class="o">-</span><span class="n">devel</span> <span class="n">wget</span> <span class="n">gd</span> <span class="n">gd</span><span class="o">-</span><span class="n">devel</span>
</pre></div>


<p><strong>2.download <a href="https://openresty.org/cn/download.html">openresty source</a></strong></p>
<div class="hlcode"><pre><span class="n">wget</span> <span class="o">-</span><span class="n">P</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span> <span class="n">https</span><span class="o">:</span><span class="c1">//github.com/openresty/openresty/releases/download/v1.11.2.1/openresty-1.11.2.1.tar.gz</span>

<span class="n">or</span>

<span class="n">curl</span> <span class="o">-</span><span class="n">fSL</span> <span class="n">https</span><span class="o">:</span><span class="c1">//github.com/openresty/openresty/releases/download/v1.11.2.1/openresty-1.11.2.1.tar.gz -o openresty-1.11.2.1.tar.gz</span>
</pre></div>


<p><strong>3.install</strong></p>
<p>Tip:</p>
<div class="hlcode"><pre><span class="cp">#如需要隐藏nginx版本号，需要在编译的时候修改nginx源码包下的src/core/nginx.h</span>
<span class="n">nginx</span><span class="err">版本显示信息如：</span><span class="n">nginx</span> <span class="n">version</span><span class="o">:</span> <span class="n">Lws</span><span class="o">/</span><span class="mf">2.0</span>
<span class="err">更改以下参数</span>
<span class="cp">#define NGINX_VERSION      &quot;2.0&quot;</span>
<span class="cp">#define NGINX_VER          &quot;Lws/&quot; NGINX_VERSION</span>
</pre></div>


<p>编译参数</p>
<blockquote>
<p>--with-http_drizzle_module depend Drizzle_module 需要先编译模块<br />
--add-module=/usr/local/src/nginx-module-vts-0.1.18 [可选：prometheus监控]<br />
--add-module=/usr/local/src/ModSecurity-nginx  [可选：ModSecurity]<br />
--add-module=/usr/local/src/nginx_upload_module-2.2.0 [可选：处理文件上载]</p>
<p>--with-http_image_filter_module  depend：yum install gd gd-devel</p>
</blockquote>
<div class="hlcode"><pre><span class="p">.</span><span class="o">/</span><span class="n">configure</span> <span class="o">--</span><span class="n">prefix</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span> \
<span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_ssl_module</span> \
<span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_stub_status_module</span> \
<span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_drizzle_module</span> \
<span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_iconv_module</span> \
<span class="o">--</span><span class="n">http</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">body</span><span class="o">-</span><span class="n">temp</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">client</span> \
<span class="o">--</span><span class="n">http</span><span class="o">-</span><span class="n">proxy</span><span class="o">-</span><span class="n">temp</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">proxy</span> \
<span class="o">--</span><span class="n">http</span><span class="o">-</span><span class="n">fastcgi</span><span class="o">-</span><span class="n">temp</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">fcgi</span> \
<span class="o">--</span><span class="n">http</span><span class="o">-</span><span class="n">uwsgi</span><span class="o">-</span><span class="n">temp</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">uwsgi</span> \
<span class="o">--</span><span class="n">http</span><span class="o">-</span><span class="n">scgi</span><span class="o">-</span><span class="n">temp</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">scgi</span> \
<span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_realip_module</span> \
<span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_image_filter_module</span> \
<span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">module</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">-</span><span class="n">vts</span><span class="o">-</span><span class="mf">0.1.18</span> \
<span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">module</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">upload</span><span class="o">-</span><span class="n">module</span> <span class="err">\</span>  <span class="err">#</span> <span class="n">check</span> <span class="n">version</span> 
<span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">module</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ModSecurity</span><span class="o">-</span><span class="n">nginx</span> \
<span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">module</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">nginx_upstream_check_module</span>
</pre></div>


<p>end：</p>
<div class="hlcode"><pre><span class="n">make</span> <span class="o">&amp;&amp;</span> <span class="n">make</span> <span class="n">install</span> 
<span class="n">echo</span> <span class="s">&quot;export PATH=/usr/local/openresty/nginx/sbin/:$PATH&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">profile</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">openresty</span><span class="p">.</span><span class="n">sh</span>
</pre></div>


<h2 id="3module">3.Module</h2>
<p><strong>1.<a href="https://openresty.org/cn/drizzle-nginx-module.html">Drizzle_module</a> <a href="https://github.com/openresty/drizzle-nginx-module">refernece</a></strong></p>
<blockquote>
<p>其他组件，如<a href="http://github.com/openresty/rds-json-nginx-module">rds-json-nginx-module</a>，<a href="http://github.com/openresty/rds-csv-nginx-module">rds-csv-nginx-module</a>或<a href="http://github.com/openresty/lua-rds-parser">lua-rds-parser</a>，以使用此模块。有关详情，请参阅<a href="https://github.com/openresty/drizzle-nginx-module#output-format">输出格式</a></p>
</blockquote>
<div class="hlcode"><pre><span class="n">wget</span> <span class="n">https</span><span class="o">:</span><span class="c1">//openresty.org/download/drizzle7-2011.07.21.tar.gz</span>
<span class="n">tar</span> <span class="n">xzvf</span> <span class="n">drizzle7</span><span class="o">-</span><span class="mf">2011.07.21</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="n">cd</span> <span class="n">drizzle7</span><span class="o">-</span><span class="mf">2011.07.21</span><span class="o">/</span>
<span class="p">.</span><span class="o">/</span><span class="n">configure</span> <span class="o">--</span><span class="n">without</span><span class="o">-</span><span class="n">server</span>
<span class="n">make</span> <span class="n">libdrizzle</span><span class="o">-</span><span class="mf">1.0</span>
<span class="n">make</span> <span class="n">install</span><span class="o">-</span><span class="n">libdrizzle</span><span class="o">-</span><span class="mf">1.0</span>
</pre></div>


<p><strong>2.nginx-module-vts-0.1.18</strong></p>
<div class="hlcode"><pre><span class="cp"># Nginx virtual host traffic status module</span>
<span class="n">wget</span> <span class="o">-</span><span class="n">P</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span> <span class="n">https</span><span class="o">:</span><span class="c1">//github.com/vozlt/nginx-module-vts/archive/v0.1.18.tar.gz</span>

<span class="cp"># promethues.conf</span>
<span class="n">vhost_traffic_status_zone</span><span class="p">;</span>
<span class="n">vhost_traffic_status_filter_by_host</span> <span class="n">on</span><span class="p">;</span>
<span class="n">server</span> <span class="p">{</span>
        <span class="n">listen</span>       <span class="mi">80</span><span class="p">;</span>
        <span class="n">server_name</span> <span class="n">localhost</span><span class="p">;</span>
        <span class="n">allow</span> <span class="mf">127.0.0.1</span><span class="p">;</span>
        <span class="n">allow</span> <span class="n">PUBIP</span><span class="o">/</span><span class="mi">32</span><span class="p">;</span>
        <span class="n">location</span> <span class="o">/</span><span class="n">status</span> <span class="p">{</span>
        <span class="n">vhost_traffic_status_display</span><span class="p">;</span>
        <span class="n">vhost_traffic_status_display_format</span> <span class="n">html</span><span class="p">;</span>
                        <span class="p">}</span>
                <span class="p">}</span>
</pre></div>


<p><strong>3.nginx_upload_module</strong> <a href="http://www.grid.net.ru/nginx/upload.en.html">REFERNECE</a></p>
<blockquote>
<p>解析请求体，处理文件上载。查看Description<br />
ngx_http_upload_module.c:14:17: fatal error: md5.h: No such file or directory <a href="https://github.com/fdintino/nginx-upload-module/issues/79">REFERNECE</a><br />
fork this https://github.com/Austinb/nginx-upload-module</p>
</blockquote>
<div class="hlcode"><pre><span class="cp"># Download sources </span>
<span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="o">:</span><span class="c1">//github.com/Austinb/nginx-upload-module.git /usr/local/src/nginx-upload-module</span>
<span class="cp"># Configure nginx with additional module </span>
<span class="n">cd</span> <span class="o">&lt;</span><span class="n">path</span> <span class="n">to</span> <span class="n">nginx</span> <span class="n">sources</span><span class="o">&gt;</span>
<span class="p">.</span><span class="o">/</span><span class="n">configure</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">module</span><span class="o">=&lt;</span><span class="n">path</span> <span class="n">to</span> <span class="n">upload</span> <span class="n">module</span> <span class="n">sources</span><span class="o">&gt;</span>
<span class="n">make</span>
<span class="n">make</span> <span class="n">install</span>
</pre></div>


<p><strong>4.nginx_upstream_check_module</strong> </p>
<div class="hlcode"><pre><span class="cp"># 下载nginx_upstream_check_module</span>
<span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="o">:</span><span class="c1">//github.com/yaoweibin/nginx_upstream_check_module.git</span>

<span class="cp"># 给openresty打补丁</span>
<span class="n">cd</span> <span class="n">openresty</span><span class="o">-</span><span class="mf">1.11.2.1</span><span class="o">/</span><span class="n">bundle</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.11.2</span><span class="o">/</span>
<span class="n">patch</span> <span class="o">-</span><span class="n">p0</span> <span class="o">&lt;</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">nginx_upstream_check_module</span><span class="o">/</span><span class="n">check_1</span><span class="mf">.11.1</span><span class="o">+</span><span class="p">.</span><span class="n">patch</span>


<span class="cp"># 如果openrety已经编译</span>
<span class="err">$</span> <span class="n">make</span>
<span class="cp"># 如果openresty全新编译</span>
<span class="err">$</span> <span class="n">gmake</span> <span class="o">&amp;&amp;</span> <span class="n">gmake</span> <span class="n">install</span>

<span class="cp"># 重新编译,把nginx拷贝到已经编译好的openresty目录即可,先备份</span>
<span class="n">cp</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="p">{</span><span class="n">nginx</span><span class="p">,</span><span class="n">nginxbak</span><span class="p">}</span>
<span class="n">cp</span> <span class="n">openresty</span><span class="o">-</span><span class="mf">1.11.2.1</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.11.2</span><span class="o">/</span><span class="n">objs</span><span class="o">/</span><span class="n">nginx</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span> <span class="o">-</span><span class="n">V</span>
</pre></div>


<p><strong>5.Others</strong></p>
<p><a href="https://github.com/simplresty/ngx_devel_kit/archive/v0.3.0.tar.gz">ngx_devel_kit_v0.3.0</a></p>
<p>https://openresty.org/cn/components.html</p>
<p><strong>6.Old</strong></p>
<blockquote>
<p>低版本使用</p>
</blockquote>
<p><strong>Redis2</strong>  </p>
<p>source bundle 已经集成</p>
<blockquote>
<p>wget https://github.com/openresty/redis2-nginx-module/archive/v0.13.tar.gz</p>
</blockquote>
<div class="hlcode"><pre><span class="cp"># openresty编译时候 --add-module=/path/to/redis2-nginx-module</span>
<span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">module</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">redis2</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">-</span><span class="mf">0.13</span>
</pre></div>


<p><strong>nginx_udplog_module (version &lt; 1.0.0)</strong> <a href="https://github.com/vkholodkov/nginx-udplog-module">REFERNECE</a> </p>
<blockquote>
<p>使用UDP发送数据报作为传输，通过syslog协议将日志发送端口514主机</p>
</blockquote>
<div class="hlcode"><pre><span class="cp"># Download sources from one of the links above. Unpack the archive:</span>
<span class="n">wget</span> <span class="o">-</span><span class="n">P</span> <span class="n">https</span><span class="o">:</span><span class="c1">//github.com/vkholodkov/nginx-udplog-module/archive/1.0.0c.tar.gz</span>
<span class="n">tar</span> <span class="n">xvzf</span> <span class="mf">1.0.0</span><span class="n">c</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="cp"># Configure nginx with additional module:</span>
<span class="n">cd</span> <span class="o">&lt;</span><span class="n">path</span> <span class="n">to</span> <span class="n">nginx</span> <span class="n">sources</span><span class="o">&gt;</span>
<span class="p">.</span><span class="o">/</span><span class="n">configure</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">module</span><span class="o">=&lt;</span><span class="n">path</span> <span class="n">to</span> <span class="n">udplog</span> <span class="n">module</span> <span class="n">sources</span><span class="o">&gt;</span>
<span class="n">make</span>
<span class="n">make</span> <span class="n">install</span>

<span class="cp"># Example configuration</span>
<span class="n">server</span> <span class="p">{</span>
    <span class="p">[...]</span>
    <span class="n">access_udplog</span> <span class="mf">192.168.2.4</span><span class="p">;</span>
    <span class="n">location</span> <span class="o">/</span><span class="n">test</span> <span class="p">{</span>
        <span class="n">access_udplog</span> <span class="n">off</span><span class="p">;</span>
        <span class="p">[...]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p><strong><a href="http://nginx.org/en/docs/syslog.html">nginx_syslog_patch</a> (nginx version &lt; 1.7.1)</strong> <a href="https://ialloc.org/blog/nginx-notes-log-syslog/">REFERNECE</a> </p>
<blockquote>
<p>add the full syslog feature to Nginx <a href="https://github.com/yaoweibin/nginx_syslog_patch">REFERNECE</a></p>
<p>yum install patch -y</p>
</blockquote>
<div class="hlcode"><pre><span class="cp">#download the latest code</span>
<span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="o">:</span><span class="c1">//github.com/yaoweibin/nginx_syslog_patch.git</span>

<span class="cp"># yum install patch </span>
<span class="cp"># pathc -p1 -R[remove] &lt; /path/to/this/directory/syslog-1.7.0.patch </span>
<span class="n">cd</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">openresty</span><span class="o">-</span><span class="mf">1.11.2.1</span><span class="o">/</span><span class="n">bundle</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.11.2</span>
<span class="n">patch</span> <span class="o">-</span><span class="n">p1</span> <span class="o">&lt;</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">nginx_syslog_patch</span><span class="o">/</span><span class="n">syslog</span><span class="o">-</span><span class="mf">1.7.0</span><span class="p">.</span><span class="n">patch</span>

<span class="cp">#add the module</span>
<span class="p">.</span><span class="o">/</span><span class="n">configure</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">module</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">nginx_syslog_patch</span>

<span class="cp"># nginx.conf &gt; version nginx 1.7.1</span>
<span class="n">access_log</span> <span class="n">syslog</span><span class="o">:</span><span class="n">server</span><span class="o">=</span><span class="n">unix</span><span class="o">:/</span><span class="n">dev</span><span class="o">/</span><span class="n">log</span><span class="p">,</span><span class="n">facility</span><span class="o">=</span><span class="n">local6</span><span class="p">,</span><span class="n">nohostname</span>  <span class="n">access</span><span class="p">;</span>
<span class="n">access_log</span> <span class="n">syslog</span><span class="o">:</span><span class="n">server</span><span class="o">=</span><span class="mf">192.168.1.1</span><span class="p">;</span>
<span class="n">access_log</span> <span class="n">syslog</span><span class="o">:</span><span class="n">server</span><span class="o">=</span><span class="n">unix</span><span class="o">:/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">nginx</span><span class="p">.</span><span class="n">sock</span>
<span class="n">access_log</span> <span class="s">&quot;syslog:server=[2001:db8::1]:12345,facility=local7,tag=nginx,</span>
            <span class="n">severity</span><span class="o">=</span><span class="n">info</span><span class="s">&quot; combined;</span>
<span class="cp"># rsyslog.conf</span>
<span class="o">:</span><span class="n">rawmsg</span><span class="p">,</span> <span class="n">contains</span><span class="p">,</span> <span class="s">&quot;nginx: &quot;</span> <span class="err">@</span><span class="mf">192.168.0.23</span><span class="o">:</span><span class="mi">514</span>
<span class="n">local6</span><span class="p">.</span><span class="o">*</span>                                                <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">hillstone</span><span class="p">.</span><span class="n">log</span>
</pre></div>


<h3 id="configuration-scripts">Configuration Scripts</h3>
<p>/etc/init.d/openresty</p>
<div class="hlcode"><pre><span class="c">#!/bin/sh</span>
<span class="c"># chkconfig: 2345 55 25</span>
<span class="c"># Description: Startup script for nginx webserver on Debian. Place in /etc/init.d and</span>
<span class="c"># run &#39;update-rc.d -f nginx defaults&#39;, or use the appropriate command on your</span>
<span class="c"># distro. For CentOS/Redhat run: &#39;chkconfig --add nginx&#39;</span>

<span class="c">### BEGIN INIT INFO</span>
<span class="c"># Provides:          nginx</span>
<span class="c"># Required-Start:    $all</span>
<span class="c"># Required-Stop:     $all</span>
<span class="c"># Default-Start:     2 3 4 5</span>
<span class="c"># Default-Stop:      0 1 6</span>
<span class="c"># Short-Description: starts the nginx web server</span>
<span class="c"># Description:       starts nginx using start-stop-daemon</span>
<span class="c">### END INIT INFO</span>

<span class="nv">PATH</span><span class="o">=</span>/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
<span class="nv">DESC</span><span class="o">=</span><span class="s2">&quot;openresty-nginx daemon&quot;</span>
<span class="nv">NAME</span><span class="o">=</span>nginx
<span class="nv">DAEMON</span><span class="o">=</span>/usr/local/openresty/nginx/sbin/<span class="nv">$NAME</span>
<span class="nv">CONFIGFILE</span><span class="o">=</span>/usr/local/openresty/nginx/conf/<span class="nv">$NAME</span>.conf
<span class="nv">PIDFILE</span><span class="o">=</span>/usr/local/openresty/nginx/logs/<span class="nv">$NAME</span>.pid
<span class="nv">SCRIPTNAME</span><span class="o">=</span>/etc/init.d/<span class="nv">$NAME</span>

<span class="nb">set</span> -e
<span class="o">[</span> -x <span class="s2">&quot;$DAEMON&quot;</span> <span class="o">]</span> <span class="o">||</span> <span class="nb">exit </span>0

do_start<span class="o">()</span> <span class="o">{</span>
 <span class="nv">$DAEMON</span> -c <span class="nv">$CONFIGFILE</span> <span class="o">||</span> <span class="nb">echo</span> -n <span class="s2">&quot;openresty already running&quot;</span>
<span class="o">}</span>

do_stop<span class="o">()</span> <span class="o">{</span>
 <span class="nb">kill</span> -INT <span class="sb">`</span>cat <span class="nv">$PIDFILE</span><span class="sb">`</span> <span class="o">||</span> <span class="nb">echo</span> -n <span class="s2">&quot;openresty not running&quot;</span>
<span class="o">}</span>

do_reload<span class="o">()</span> <span class="o">{</span>
 <span class="nb">kill</span> -HUP <span class="sb">`</span>cat <span class="nv">$PIDFILE</span><span class="sb">`</span> <span class="o">||</span> <span class="nb">echo</span> -n <span class="s2">&quot;openresty can&#39;t reload&quot;</span>
<span class="o">}</span>

<span class="k">case</span> <span class="s2">&quot;$1&quot;</span> in
 start<span class="o">)</span>
 <span class="nb">echo</span> -n <span class="s2">&quot;Starting $DESC: $NAME&quot;</span>
 do_start
 <span class="nb">echo</span> <span class="s2">&quot;.&quot;</span>
 ;;
 stop<span class="o">)</span>
 <span class="nb">echo</span> -n <span class="s2">&quot;Stopping $DESC: $NAME&quot;</span>
 do_stop
 <span class="nb">echo</span> <span class="s2">&quot;.&quot;</span>
 ;;
 reload|graceful<span class="o">)</span>
 <span class="nb">echo</span> -n <span class="s2">&quot;Reloading $DESC configuration...&quot;</span>
 do_reload
 <span class="nb">echo</span> <span class="s2">&quot;.&quot;</span>
 ;;
 restart<span class="o">)</span>
 <span class="nb">echo</span> -n <span class="s2">&quot;Restarting $DESC: $NAME&quot;</span>
 do_stop
 do_start
 <span class="nb">echo</span> <span class="s2">&quot;.&quot;</span>
 ;;
 *<span class="o">)</span>
 <span class="nb">echo</span> <span class="s2">&quot;Usage: $SCRIPTNAME {start|stop|reload|restart}&quot;</span> &gt;&amp;2
 <span class="nb">exit </span>3
 ;;
<span class="k">esac</span>

<span class="nb">exit </span>0
</pre></div>


<h3 id="proxy-deploy">Proxy deploy</h3>
<p>1.depend</p>
<div class="hlcode"><pre><span class="n">yum</span> <span class="n">install</span> <span class="n">pcre</span><span class="o">-</span><span class="n">devel</span> <span class="n">openssl</span><span class="o">-</span><span class="n">devel</span> <span class="n">gcc</span> <span class="n">curl</span> <span class="n">postgresql</span><span class="o">-</span><span class="n">devel</span> <span class="n">wget</span>

<span class="cp"># downlaod openresty</span>
<span class="n">wget</span> <span class="o">-</span><span class="n">P</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span> <span class="n">https</span><span class="o">:</span><span class="c1">//github.com/openresty/openresty/releases/download/v1.11.2.1/openresty-1.11.2.1.tar.gz</span>
</pre></div>


<p>2.module</p>
<div class="hlcode"><pre><span class="cp"># drizzle7</span>
<span class="n">wget</span> <span class="n">https</span><span class="o">:</span><span class="c1">//openresty.org/download/drizzle7-2011.07.21.tar.gz</span>
<span class="n">tar</span> <span class="n">xzvf</span> <span class="n">drizzle7</span><span class="o">-</span><span class="mf">2011.07.21</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="n">cd</span> <span class="n">drizzle7</span><span class="o">-</span><span class="mf">2011.07.21</span><span class="o">/</span>
<span class="p">.</span><span class="o">/</span><span class="n">configure</span> <span class="o">--</span><span class="n">without</span><span class="o">-</span><span class="n">server</span>
<span class="n">make</span> <span class="n">libdrizzle</span><span class="o">-</span><span class="mf">1.0</span>
<span class="n">make</span> <span class="n">install</span><span class="o">-</span><span class="n">libdrizzle</span><span class="o">-</span><span class="mf">1.0</span>

<span class="cp"># ngxin-module-vts</span>
<span class="n">wget</span> <span class="o">-</span><span class="n">P</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span> <span class="n">https</span><span class="o">:</span><span class="c1">//github.com/vozlt/nginx-module-vts/archive/v0.1.18.tar.gz </span>
</pre></div>


<p>3.编译参数</p>
<div class="hlcode"><pre><span class="p">.</span><span class="o">/</span><span class="n">configure</span> <span class="o">--</span><span class="n">prefix</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span> \
<span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">luajit</span> \
<span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_ssl_module</span> \
<span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_stub_status_module</span> \
<span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_drizzle_module</span> \
<span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_iconv_module</span> \
<span class="o">--</span><span class="n">http</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">body</span><span class="o">-</span><span class="n">temp</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">client</span> \
<span class="o">--</span><span class="n">http</span><span class="o">-</span><span class="n">proxy</span><span class="o">-</span><span class="n">temp</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">proxy</span> \
<span class="o">--</span><span class="n">http</span><span class="o">-</span><span class="n">fastcgi</span><span class="o">-</span><span class="n">temp</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">fcgi</span> \
<span class="o">--</span><span class="n">http</span><span class="o">-</span><span class="n">uwsgi</span><span class="o">-</span><span class="n">temp</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">uwsgi</span> \
<span class="o">--</span><span class="n">http</span><span class="o">-</span><span class="n">scgi</span><span class="o">-</span><span class="n">temp</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">scgi</span> \
<span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_realip_module</span> \
<span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_image_filter_module</span> \
<span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">module</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">module</span><span class="o">-</span><span class="n">vts</span><span class="o">-</span><span class="mf">0.1.18</span> 
</pre></div>


<p>End </p>
<div class="hlcode"><pre><span class="n">make</span> <span class="o">&amp;&amp;</span> <span class="n">make</span> <span class="n">install</span> 
</pre></div>


<p>Other</p>
<div class="hlcode"><pre><span class="mf">4.</span><span class="err">同步节点</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">openresty</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span> 
<span class="mf">6.</span><span class="n">DNS</span><span class="err">解析切换</span>
<span class="mf">7.</span><span class="err">添加白名单</span>
    <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">cluster</span><span class="o">/</span><span class="n">proxy</span><span class="o">/</span><span class="n">waf</span><span class="o">/</span><span class="n">config</span><span class="p">.</span><span class="n">lua</span>
    <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">cluster</span><span class="o">/</span><span class="n">web</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">wafnew</span>
<span class="mf">8.</span><span class="n">mon</span> 
    <span class="n">cacti</span><span class="p">,</span><span class="n">icinga</span>
    <span class="n">somokeping</span>
<span class="mf">9.</span><span class="n">nginx</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">cluster</span><span class="o">/</span><span class="n">proxy</span><span class="o">/</span><span class="n">proxy</span><span class="p">.</span><span class="n">conf</span> <span class="p">{</span><span class="n">add</span> <span class="n">newip</span><span class="p">}</span>
<span class="mf">10.</span><span class="n">prometheus</span> <span class="n">modify</span> <span class="n">ip</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">prometheus</span><span class="o">/</span><span class="n">prometheus</span><span class="p">.</span><span class="n">conf</span>
<span class="mf">11.</span><span class="n">srccode</span> <span class="n">rsync</span> <span class="n">modify</span> <span class="n">ip</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">cluster</span><span class="o">/</span><span class="n">sa</span><span class="o">/</span><span class="n">sersync</span><span class="o">/</span><span class="n">proxy</span><span class="p">.</span><span class="n">xml</span> 
</pre></div>
  
</div>
    </div>
    <div id="footer">
      <div class="footer-left">
        <p>
        Copyright © 2019 Uxun.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
        Theme by <a href="https://github.com/tankywoo/yasimple_x2" target="_blank">YASimple_X2</a>.
        </p>
      </div> <!-- end footer-left -->
      <div class="footer-right">
        <p>Page Updated 2019-09-25 22:39:26</p>
      </div> <!-- end footer-right -->
    </div>

    
    

  </body>
</html>
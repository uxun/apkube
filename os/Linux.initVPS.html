<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/colorful.css">
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/style.css">
    <link rel="shortcut icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>VPS - Uxun's WIKI</title>
    <meta name="keywords" content=""/>
    <meta name="description" content=""/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
  </head>

  <body>
    <div id="container" class="typo">
      
<div id="header">
  <div id="post-nav">
    <a href="/wiki/">Uxun's WIKI</a>
    &nbsp;&#187;&nbsp;
    <a href="/wiki/#os">os</a>
    &nbsp;&#187;&nbsp;VPS
    <span class="updated">Page Updated&nbsp;
    
    </span>
  </div>
</div>
<div class="clearfix"></div>
<div id="content">
  <h1 id="vps">VPS</h1>
<h3 id="configuration-items">Configuration items</h3>
<div class="hlcode"><pre><span class="mf">1.</span><span class="err">禁用</span><span class="n">root</span><span class="err">远程登录</span> <span class="n">adduser</span> <span class="n">config</span> <span class="n">sudouser</span>
<span class="mf">2.</span><span class="err">禁</span><span class="n">ping</span>
<span class="mf">3.</span><span class="err">限制帐号多重登录</span>
<span class="mf">4.</span><span class="err">防止暴力破解</span> <span class="err">（</span><span class="n">fail2ban</span><span class="p">,</span><span class="n">denyhosts</span><span class="err">）</span>
<span class="mf">5.f</span><span class="n">irewall</span> 
</pre></div>


<h3 id="shell">Shell</h3>
<div class="hlcode"><pre><span class="cp"># vps create user </span>
<span class="n">useradd</span> <span class="err">$</span><span class="n">USER</span> <span class="o">&amp;&amp;</span> <span class="n">passwd</span> <span class="err">$</span><span class="n">USER</span> <span class="err">$</span><span class="n">password</span>

<span class="cp"># mac make a key</span>
<span class="n">ssh</span><span class="o">-</span><span class="n">keygen</span> <span class="o">-</span><span class="n">t</span> <span class="n">rsa</span> <span class="o">-</span><span class="n">C</span> <span class="err">&#39;</span><span class="n">YOU</span><span class="err">@</span><span class="n">MAIL</span><span class="p">.</span><span class="n">com</span><span class="err">&#39;</span> <span class="o">-</span><span class="n">f</span> <span class="o">~/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">id_rsa_bwg</span>
<span class="n">sh</span><span class="o">-</span><span class="n">copy</span><span class="o">-</span><span class="n">id</span> <span class="o">-</span><span class="n">i</span> <span class="o">~/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">id_rsa_bwg</span><span class="p">.</span><span class="n">pub</span> <span class="n">user</span><span class="err">@</span><span class="n">host</span> <span class="o">-</span><span class="n">p</span> <span class="n">port</span>

<span class="cp"># ssh配置</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">UseDNS</span><span class="o">/</span><span class="n">s</span><span class="o">/^</span><span class="p">.</span><span class="o">*</span><span class="err">$</span><span class="o">/</span><span class="n">UseDNS</span> <span class="n">no</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">sshd_config</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="n">GSSAPIAuthentication</span> <span class="n">yes</span><span class="o">/</span><span class="n">GSSAPIAuthentication</span> <span class="n">no</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">sshd_config</span>

<span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">sshd_config</span>
<span class="n">Port</span> <span class="mi">6666</span>                               <span class="err">#随意修改一个端口</span>
<span class="n">PermitRootLogin</span> <span class="n">no</span>                      <span class="err">#禁止</span><span class="n">root</span><span class="err">登录</span>
<span class="n">RSAAuthentication</span> <span class="n">yes</span>                   <span class="err">#</span><span class="n">RSA</span><span class="err">认证</span>
<span class="n">PubkeyAuthentication</span> <span class="n">yes</span>                <span class="err">#开启公钥验证</span>
<span class="n">AuthorizedKeysFile</span> <span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">authorized_keys</span> <span class="err">#验证文件路径</span>
<span class="n">PasswordAuthentication</span> <span class="n">no</span>               <span class="err">#禁止密码认证</span>
<span class="n">PermitEmptyPasswords</span> <span class="n">no</span>                 <span class="err">#禁止空密码</span>
<span class="n">UsePAM</span> <span class="n">no</span>                               <span class="err">#禁用</span><span class="n">PAM</span>

<span class="n">systemctl</span> <span class="n">restart</span> <span class="n">sshd</span>  <span class="err">#</span> <span class="err">重启</span><span class="n">ssh</span><span class="err">服务</span>

<span class="cp"># 1.1 避免root密码被蓦改</span>
<span class="err">$</span> <span class="n">chattr</span> <span class="o">+</span><span class="n">i</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span><span class="p">;</span> <span class="n">chattr</span> <span class="o">+</span><span class="n">i</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shadow</span>

<span class="cp"># 1.2 vim /etc/profile</span>
<span class="n">HISTSIZE</span><span class="o">=</span><span class="mi">100000</span>
<span class="n">export</span> <span class="n">HISTTIMEFORMAT</span><span class="o">=</span><span class="s">&quot;%F %T &quot;</span>

<span class="cp"># 1.3 vim /etc/sudoer</span>
<span class="cp">## Allow root to run any commands anywhere</span>
<span class="n">user</span>     <span class="n">ALL</span><span class="o">=</span><span class="p">(</span><span class="n">ALL</span><span class="p">)</span>       <span class="n">NOPASSWD</span><span class="o">:</span><span class="n">ALL</span>

<span class="cp"># 禁止 ping</span>
<span class="n">echo</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">ipv4</span><span class="o">/</span><span class="n">icmp_echo_ignore_all</span>
<span class="cp"># 允许 ping</span>
<span class="n">echo</span> <span class="mi">0</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">ipv4</span><span class="o">/</span><span class="n">icmp_echo_ignore_all</span>
<span class="err">ø</span>
<span class="mf">3.</span><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">security</span><span class="o">/</span><span class="n">limits</span><span class="p">.</span><span class="n">conf</span>
<span class="o">*</span>               <span class="n">hard</span>    <span class="n">maxlogins</span>       <span class="mi">2</span>
</pre></div>


<h2 id="shadowsock-server">shadowsock server</h2>
<p><a href="https://xiaozhou.net/enable-bbr-for-vps-2017-06-10.html">BBR控制算法</a></p>
<p><a href="https://blog.phpgao.com/shadowsocks_on_linux.html">老高的博客</a></p>
<div class="hlcode"><pre><span class="cp"># </span>
<span class="n">yum</span> <span class="n">install</span> <span class="n">python</span><span class="o">-</span><span class="n">setuptools</span>
<span class="n">easy_install</span> <span class="n">pip</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">shadowsocks</span>
<span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shadowsocks</span><span class="p">.</span><span class="n">json</span>
<span class="cp"># 单用户</span>
<span class="p">{</span>
    <span class="s">&quot;server&quot;</span><span class="o">:</span> <span class="s">&quot;my-server&quot;</span><span class="p">,</span>  <span class="err">#主机名或服务器</span><span class="n">IP</span><span class="err">（</span><span class="n">IPv4</span><span class="o">/</span><span class="n">IPv6</span><span class="err">）</span>
    <span class="s">&quot;server_port&quot;</span><span class="o">:</span> <span class="mi">9001</span><span class="p">,</span> <span class="err">#服务器端口号</span>
    <span class="s">&quot;local_port&quot;</span><span class="o">:</span> <span class="mi">8789</span><span class="p">,</span> <span class="err">#本地端口号</span>
    <span class="s">&quot;password&quot;</span><span class="o">:</span> <span class="s">&quot;password0&quot;</span><span class="p">,</span>
    <span class="s">&quot;timeout&quot;</span><span class="o">:</span> <span class="mi">600</span><span class="p">,</span>
    <span class="s">&quot;method&quot;</span><span class="o">:</span> <span class="s">&quot;aes-256-cfb&quot;</span><span class="p">,</span>
    <span class="s">&quot;auth&quot;</span><span class="o">:</span> <span class="nb">true</span> <span class="err">#一次性认证，设置为</span><span class="n">true</span><span class="err">以启用一次性认证功能</span>
<span class="p">}</span>
<span class="cp"># 多用户</span>
<span class="p">{</span>
    <span class="s">&quot;server&quot;</span><span class="o">:</span><span class="s">&quot;my-ssserver&quot;</span><span class="p">,</span>
    <span class="s">&quot;local_address&quot;</span><span class="o">:</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span>
    <span class="s">&quot;local_port&quot;</span><span class="o">:</span><span class="mi">8888</span><span class="p">,</span>
    <span class="s">&quot;port_password&quot;</span><span class="o">:</span><span class="p">{</span>  <span class="err">#格式为“服务器端口”</span><span class="o">:</span><span class="err">”用于加密传输的密码”，一行对应一个端口及其密#</span>
         <span class="s">&quot;9001&quot;</span><span class="o">:</span><span class="s">&quot;password1&quot;</span><span class="p">,</span>
         <span class="s">&quot;9002&quot;</span><span class="o">:</span><span class="s">&quot;password2&quot;</span><span class="p">,</span>
         <span class="s">&quot;9003&quot;</span><span class="o">:</span><span class="s">&quot;password3&quot;</span><span class="p">,</span>
         <span class="s">&quot;9004&quot;</span><span class="o">:</span><span class="s">&quot;password4&quot;</span>
    <span class="p">},</span>
    <span class="s">&quot;timeout&quot;</span><span class="o">:</span><span class="mi">600</span><span class="p">,</span>
    <span class="s">&quot;method&quot;</span><span class="o">:</span><span class="s">&quot;aes-256-cfb&quot;</span><span class="p">,</span>
    <span class="s">&quot;fast_open&quot;</span><span class="o">:</span> <span class="nb">false</span>
<span class="p">}</span>

<span class="cp"># 测试端口</span>
<span class="err">$</span> <span class="n">sslocal</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shadowsocks</span><span class="p">.</span><span class="n">json</span> 
<span class="nl">INFO:</span> <span class="n">loading</span> <span class="n">config</span> <span class="n">from</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shadowsocks</span><span class="p">.</span><span class="n">json</span>
<span class="mi">2018</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mi">56</span><span class="o">:</span><span class="mo">06</span> <span class="n">INFO</span>     <span class="n">loading</span> <span class="n">libcrypto</span> <span class="n">from</span> <span class="n">libcrypto</span><span class="p">.</span><span class="n">so</span><span class="mf">.10</span>
<span class="mi">2018</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">13</span> <span class="mi">21</span><span class="o">:</span><span class="mi">56</span><span class="o">:</span><span class="mo">06</span> <span class="n">INFO</span>     <span class="n">starting</span> <span class="n">local</span> <span class="n">at</span> <span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">8789</span>

<span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">zone</span><span class="o">=</span><span class="n">public</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">9001</span><span class="o">/</span><span class="n">tcp</span> <span class="o">--</span><span class="n">permanent</span>
<span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">zone</span><span class="o">=</span><span class="n">public</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">9001</span><span class="o">/</span><span class="n">udp</span> <span class="o">--</span><span class="n">permanent</span>
<span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">reload</span>
</pre></div>


<p><strong>Service</strong></p>
<div class="hlcode"><pre><span class="n">cat</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">ss</span><span class="p">.</span><span class="n">service</span> <span class="o">&lt;&lt;</span> <span class="n">EOF</span>
<span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="n">Shadowsocks</span> <span class="n">Server</span>
<span class="n">After</span><span class="o">=</span><span class="n">network</span><span class="p">.</span><span class="n">target</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">PermissionsStartOnly</span><span class="o">=</span><span class="nb">true</span>
<span class="n">ExecStartPre</span><span class="o">=/</span><span class="n">bin</span><span class="o">/</span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">shadowsocks</span>
<span class="n">ExecStartPre</span><span class="o">=/</span><span class="n">bin</span><span class="o">/</span><span class="n">chown</span> <span class="n">nobody</span><span class="o">:</span><span class="n">nobody</span> <span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">shadowsocks</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ssserver</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shadowsocks</span><span class="p">.</span><span class="n">json</span>
<span class="n">Restart</span><span class="o">=</span><span class="n">on</span><span class="o">-</span><span class="n">abort</span>
<span class="n">User</span><span class="o">=</span><span class="n">nobody</span>
<span class="n">Group</span><span class="o">=</span><span class="n">nobody</span>
<span class="n">UMask</span><span class="o">=</span><span class="mo">0027</span>
<span class="n">LimitNOFILE</span><span class="o">=</span><span class="mi">51200</span>

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="p">.</span><span class="n">target</span>
<span class="n">EOF</span>
</pre></div>


<p>End</p>
<p><code>systemctl start ss &amp;&amp; systemctl enable ss</code></p>
<h2 id="install-polipo">install polipo</h2>
<p><a href="https://www.irif.fr/~jch//software/polipo/">官方</a></p>
<p><a href="https://github.com/jech/polipo">github</a></p>
<div class="hlcode"><pre><span class="cp"># 编译时依赖软件</span>
<span class="err">$</span> <span class="n">yum</span> <span class="n">install</span> <span class="n">texinfo</span> <span class="n">gcc</span> <span class="n">git</span> <span class="o">-</span><span class="n">y</span>       
<span class="err">$</span> <span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="o">:</span><span class="c1">//github.com/jech/polipo.git</span>
<span class="err">$</span> <span class="n">cd</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">polipo</span>
<span class="err">$</span> <span class="n">make</span> <span class="n">all</span> <span class="o">&amp;&amp;</span> <span class="n">make</span> <span class="n">install</span>

<span class="err">$</span> <span class="n">mkdir</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">polipo</span>
<span class="err">$</span> <span class="n">cp</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">polipo</span><span class="o">/</span><span class="n">config</span><span class="p">.</span><span class="n">sample</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">polipo</span><span class="o">/</span><span class="n">config</span>

<span class="cp"># config</span>
<span class="n">cat</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">polipo</span><span class="p">.</span><span class="n">service</span> <span class="o">&lt;&lt;</span> <span class="n">EOF</span>
<span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="n">polipo</span> <span class="n">web</span> <span class="n">proxy</span>
<span class="n">After</span><span class="o">=</span><span class="n">network</span><span class="p">.</span><span class="n">target</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">Type</span><span class="o">=</span><span class="n">simple</span>
<span class="n">WorkingDirectory</span><span class="o">=/</span><span class="n">tmp</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">polipo</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">polipo</span><span class="o">/</span><span class="n">config</span>
<span class="n">Restart</span><span class="o">=</span><span class="n">always</span>
<span class="n">SyslogIdentifier</span><span class="o">=</span><span class="n">Polipo</span>

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="p">.</span><span class="n">target</span>
<span class="n">EOF</span>

<span class="cp">#vim /opt/polipo/config</span>
<span class="n">logSyslog</span> <span class="o">=</span> <span class="nb">true</span>
<span class="n">logFile</span> <span class="o">=</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">polipo</span><span class="o">/</span><span class="n">polipo</span><span class="p">.</span><span class="n">log</span>
<span class="n">pidFile</span> <span class="o">=</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">polipo</span><span class="p">.</span><span class="n">pid</span>
<span class="n">proxyAddress</span> <span class="o">=</span> <span class="s">&quot;0.0.0.0&quot;</span>
<span class="n">proxyPort</span> <span class="o">=</span> <span class="mi">8123</span>
<span class="n">proxyAddress</span> <span class="o">=</span> <span class="s">&quot;0.0.0.0&quot;</span>
<span class="n">authCredentials</span> <span class="o">=</span> <span class="n">pig</span><span class="o">:</span><span class="n">pig123456</span>
<span class="cp">#socksParentProxy = &quot;127.0.0.1:8789&quot;</span>
<span class="cp">#socksProxyType = socks5</span>
<span class="cp">#diskCacheRoot = &quot;&quot;</span>

<span class="cp">#测试 curl ip.gs</span>
<span class="n">export</span> <span class="n">https_proxy</span><span class="o">=</span><span class="n">http</span><span class="o">:</span><span class="c1">//pig:pig123456@97.64.126.76:8123;export http_proxy=http://pig:pig123456@97.64.126.76:8123</span>
</pre></div>


<p><strong>ssh防止暴力破解 （denyhosts，fail2ban）</strong></p>
<blockquote>
<p>fail2ban  <a href="https://linode.com/docs/security/using-fail2ban-for-security/">参考</a></p>
</blockquote>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">yum</span> <span class="n">install</span> <span class="n">fail2ban</span>
<span class="err">$</span> <span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fail2ban</span><span class="o">/</span><span class="n">jail</span><span class="p">.{,.</span><span class="n">local</span><span class="p">}</span>

<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fail2ban</span><span class="o">/</span><span class="n">jail</span><span class="p">.</span><span class="n">conf</span>
<span class="p">[</span><span class="n">DEFAULT</span><span class="p">]</span>
<span class="cp"># &quot;ignoreip&quot; can be an IP address, a CIDR mask or a DNS host. Fail2ban will not</span>
<span class="cp"># ban a host which matches an address in this list. Several addresses can be</span>
<span class="cp"># defined using space separator.</span>
<span class="n">ignoreip</span> <span class="o">=</span> <span class="mf">127.0.0.1</span><span class="o">/</span><span class="mi">8</span> <span class="mf">123.45.67.89</span>

<span class="cp"># &quot;bantime&quot; is the number of seconds that a host is banned.</span>
<span class="n">bantime</span>  <span class="o">=</span> <span class="mi">600</span>

<span class="cp"># A host is banned if it has generated &quot;maxretry&quot; during the last &quot;findtime&quot;</span>
<span class="cp"># seconds.</span>
<span class="n">findtime</span> <span class="o">=</span> <span class="mi">600</span>
<span class="n">maxretry</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>


<p><strong>denyhosts</strong></p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">yum</span> <span class="n">install</span> <span class="n">denyhosts</span> 
<span class="err">$</span> <span class="n">service</span> <span class="n">denyhosts</span> <span class="n">stop</span>
<span class="n">hosts</span><span class="p">.</span><span class="n">deny</span><span class="err">同规则</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span><span class="p">.</span><span class="n">deny</span>
<span class="nl">sshd:</span><span class="o">*</span><span class="p">.</span><span class="o">*</span><span class="p">.</span><span class="o">*</span><span class="p">.</span><span class="o">*</span>

<span class="p">(</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">denyhosts</span><span class="p">.</span><span class="n">conf</span><span class="p">)</span>
<span class="n">SECURE_LOG</span> <span class="o">=</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">secure</span> <span class="err">#</span><span class="n">ssh</span> <span class="err">日志文件</span><span class="p">,</span><span class="err">系统不同</span><span class="p">,</span><span class="err">文件不相同</span>
<span class="n">HOSTS_DENY</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span><span class="p">.</span><span class="n">deny</span> <span class="err">#控制用户登陆的文件</span>
<span class="n">PURGE_DENY</span> <span class="o">=</span> <span class="err">#过多久后清除已经禁止的，空表示永远不解禁</span>
<span class="n">BLOCK_SERVICE</span> <span class="o">=</span> <span class="n">sshd</span> <span class="err">#禁止的服务名，如还要添加其他服务，只需添加逗号跟上相应的服务即可</span>
<span class="n">DENY_THRESHOLD_INVALID</span> <span class="o">=</span> <span class="mi">5</span> <span class="err">#允许无效用</span><span class="n">t</span><span class="err">户失败的次数</span>
<span class="n">DENY_THRESHOLD_VALID</span> <span class="o">=</span> <span class="mi">10</span> <span class="err">#允许普通用户登陆失败的次数</span>
<span class="n">DENY_THRESHOLD_ROOT</span> <span class="o">=</span> <span class="mi">1</span> <span class="err">#允许</span><span class="n">root</span><span class="err">登陆失败的次数</span>
<span class="n">DENY_THRESHOLD_RESTRICTED</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">WORK_DIR</span> <span class="o">=</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">denyhosts</span> <span class="err">#运行目录</span>
<span class="n">SUSPICIOUS_LOGIN_REPORT_ALLOWED_HOSTS</span><span class="o">=</span><span class="n">YES</span>
<span class="n">HOSTNAME_LOOKUP</span><span class="o">=</span><span class="n">YES</span> <span class="err">#是否进行域名反解析</span>
<span class="n">LOCK_FILE</span> <span class="o">=</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">denyhosts</span><span class="p">.</span><span class="n">pid</span> <span class="err">#程序的进程</span><span class="n">ID</span>
<span class="n">ADMIN_EMAIL</span> <span class="o">=</span> <span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="err">#管理员邮件地址</span><span class="p">,</span><span class="err">它会给管理员发邮件</span>
<span class="n">SMTP_HOST</span> <span class="o">=</span> <span class="n">localhost</span>
<span class="n">SMTP_PORT</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">SMTP_FROM</span> <span class="o">=</span> <span class="n">DenyHosts</span> <span class="o">&lt;</span><span class="n">nobody</span><span class="err">@</span><span class="n">localhost</span><span class="o">&gt;</span>
<span class="n">SMTP_SUBJECT</span> <span class="o">=</span> <span class="n">DenyHosts</span> <span class="n">Report</span>
<span class="n">AGE_RESET_VALID</span><span class="o">=</span><span class="mi">5</span><span class="n">d</span> <span class="err">#用户的登录失败计数会在多久以后重置为</span><span class="mi">0</span><span class="err">，</span><span class="p">(</span><span class="n">h</span><span class="err">表示小时，</span><span class="n">d</span><span class="err">表示天，</span><span class="n">m</span><span class="err">表示月，</span><span class="n">w</span><span class="err">表示周，</span><span class="n">y</span><span class="err">表示年</span><span class="p">)</span>
<span class="n">AGE_RESET_ROOT</span><span class="o">=</span><span class="mi">25</span><span class="n">d</span>
<span class="n">AGE_RESET_RESTRICTED</span><span class="o">=</span><span class="mi">25</span><span class="n">d</span>
<span class="n">AGE_RESET_INVALID</span><span class="o">=</span><span class="mi">10</span><span class="n">d</span>
<span class="n">RESET_ON_SUCCESS</span> <span class="o">=</span> <span class="n">yes</span> <span class="err">#如果一个</span><span class="n">ip</span><span class="err">登陆成功后，失败的登陆计数是否重置为</span><span class="mi">0</span>
<span class="n">DAEMON_LOG</span> <span class="o">=</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">denyhosts</span> <span class="err">#自己的日志文件</span>
<span class="n">DAEMON_SLEEP</span> <span class="o">=</span> <span class="mi">30</span><span class="n">s</span> <span class="err">#当以后台方式运行时，每读一次日志文件的时间间隔。</span>
</pre></div>


<p><strong>优化VPS</strong></p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">security</span><span class="o">/</span><span class="n">limits</span><span class="p">.</span><span class="n">conf</span>
<span class="o">*</span> <span class="n">soft</span> <span class="n">nofile</span> <span class="mi">51200</span>
<span class="o">*</span> <span class="n">hard</span> <span class="n">nofile</span> <span class="mi">51200</span>

<span class="err">$</span> <span class="n">ulimit</span> <span class="o">-</span><span class="n">n</span> <span class="mi">51200</span>

<span class="err">$</span> <span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">conf</span>
<span class="n">fs</span><span class="p">.</span><span class="n">file</span><span class="o">-</span><span class="n">max</span> <span class="o">=</span> <span class="mi">51200</span>

<span class="n">net</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">rmem_max</span> <span class="o">=</span> <span class="mi">67108864</span>
<span class="n">net</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">wmem_max</span> <span class="o">=</span> <span class="mi">67108864</span>
<span class="n">net</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">netdev_max_backlog</span> <span class="o">=</span> <span class="mi">250000</span>
<span class="n">net</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">somaxconn</span> <span class="o">=</span> <span class="mi">4096</span>

<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_syncookies</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_tw_reuse</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_tw_recycle</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_fin_timeout</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_keepalive_time</span> <span class="o">=</span> <span class="mi">1200</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_local_port_range</span> <span class="o">=</span> <span class="mi">10000</span> <span class="mi">65000</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_max_syn_backlog</span> <span class="o">=</span> <span class="mi">8192</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_max_tw_buckets</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_fastopen</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_mem</span> <span class="o">=</span> <span class="mi">25600</span> <span class="mi">51200</span> <span class="mi">102400</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_rmem</span> <span class="o">=</span> <span class="mi">4096</span> <span class="mi">87380</span> <span class="mi">67108864</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_wmem</span> <span class="o">=</span> <span class="mi">4096</span> <span class="mi">65536</span> <span class="mi">67108864</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_mtu_probing</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_congestion_control</span> <span class="o">=</span> <span class="n">hybla</span>

<span class="err">$</span> <span class="n">sysctl</span> <span class="o">-</span><span class="n">p</span>
</pre></div>


<p><strong>firewall</strong></p>
<div class="hlcode"><pre><span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">iptables</span><span class="p">.</span><span class="n">firewall</span><span class="p">.</span><span class="n">rules</span>

<span class="o">*</span><span class="n">filter</span>

<span class="cp">#  Allow all loopback (lo0) traffic and drop all traffic to 127/8 that doesn’t use lo0</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">lo</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">d</span> <span class="mf">127.0.0.0</span><span class="o">/</span><span class="mi">8</span> <span class="o">-</span><span class="n">j</span> <span class="n">REJECT</span>

<span class="cp">#  Accept all established inbound connections</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="err">–</span><span class="n">state</span> <span class="n">ESTABLISHED</span><span class="p">,</span><span class="n">RELATED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>

<span class="cp">#  Allow all outbound traffic – you can modify this to only allow certain traffic</span>
<span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>

<span class="cp">#  Allow HTTP and HTTPS connections from anywhere (the normal ports for websites and SSL).</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="err">–</span><span class="n">dport</span> <span class="mi">80</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="err">–</span><span class="n">dport</span> <span class="mi">443</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>

<span class="cp">#  Allow SSH connections</span>
<span class="cp">#</span>
<span class="cp">#  The -dport number should be the same port number you set in sshd_config</span>
<span class="cp">#</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="err">–</span><span class="n">state</span> <span class="n">NEW</span> <span class="err">–</span><span class="n">dport</span> <span class="mi">7879</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>

<span class="cp">#  Allow ping</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">icmp</span> <span class="o">-</span><span class="n">m</span> <span class="n">icmp</span> <span class="err">–</span><span class="n">icmp</span><span class="o">-</span><span class="n">type</span> <span class="mi">8</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>

<span class="cp">#  Log iptables denied calls</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">m</span> <span class="n">limit</span> <span class="err">–</span><span class="n">limit</span> <span class="mi">5</span><span class="o">/</span><span class="n">min</span> <span class="o">-</span><span class="n">j</span> <span class="n">LOG</span> <span class="err">–</span><span class="n">log</span><span class="o">-</span><span class="n">prefix</span> <span class="err">“</span><span class="n">iptables</span> <span class="n">denied</span><span class="o">:</span> <span class="err">”</span> <span class="err">–</span><span class="n">log</span><span class="o">-</span><span class="n">level</span> <span class="mi">7</span>

<span class="cp">#  Reject all other inbound – default deny unless explicitly allowed policy</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">j</span> <span class="n">REJECT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">FORWARD</span> <span class="o">-</span><span class="n">j</span> <span class="n">REJECT</span>

<span class="n">COMMIT</span>
<span class="err">$</span> <span class="n">iptables</span><span class="o">-</span><span class="n">restore</span> <span class="o">&lt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">iptables</span><span class="p">.</span><span class="n">firewall</span><span class="p">.</span><span class="n">rules</span>
</pre></div>
  
</div>
    </div>
    <div id="footer">
      <div class="footer-left">
        <p>
        Copyright © 2019 Uxun.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
        Theme by <a href="https://github.com/tankywoo/yasimple_x2" target="_blank">YASimple_X2</a>.
        </p>
      </div> <!-- end footer-left -->
      <div class="footer-right">
        <p>Page Updated 2019-09-19 16:47:12</p>
      </div> <!-- end footer-right -->
    </div>

    
    

  </body>
</html>
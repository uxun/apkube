<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/colorful.css">
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/style.css">
    <link rel="shortcut icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>Supervisor - Uxun's WIKI</title>
    <meta name="keywords" content=""/>
    <meta name="description" content=""/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
  </head>

  <body>
    <div id="container" class="typo">
      
<div id="header">
  <div id="post-nav">
    <a href="/wiki/">Uxun's WIKI</a>
    &nbsp;&#187;&nbsp;
    <a href="/wiki/#../../../Dropbox/wiki/os">../../../Dropbox/wiki/os</a>
    &nbsp;&#187;&nbsp;Supervisor
    <span class="updated">Page Updated&nbsp;
    2019-08-20 00:00
    </span>
  </div>
</div>
<div class="clearfix"></div>
<div id="content">
  <h1 id="supervisor">Supervisor</h1>
<blockquote>
<p>c/s系统，用来在类Unix系统中监控进程状态。</p>
</blockquote>
<h3 id="1install">1.Install</h3>
<div class="hlcode"><pre><span class="cp"># Yum</span>
<span class="n">wget</span> <span class="o">-</span><span class="n">O</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">yum</span><span class="p">.</span><span class="n">repos</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">epel</span><span class="p">.</span><span class="n">repo</span> <span class="n">http</span><span class="o">:</span><span class="c1">//mirrors.aliyun.com/repo/epel-6.repo</span>
<span class="n">wget</span> <span class="o">-</span><span class="n">O</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">yum</span><span class="p">.</span><span class="n">repos</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">epel</span><span class="p">.</span><span class="n">repo</span> <span class="n">http</span><span class="o">:</span><span class="c1">//mirrors.aliyun.com/repo/epel-7.repo</span>
<span class="n">yum</span> <span class="n">install</span> <span class="n">supervisor</span>

<span class="cp"># Easy_install</span>
<span class="n">yum</span> <span class="n">install</span> <span class="n">python</span><span class="o">-</span><span class="n">setuptools</span> <span class="o">-</span><span class="n">y</span>
<span class="n">easy_install</span> <span class="n">supervisor</span>
<span class="n">mkdir</span> <span class="o">-</span><span class="n">pv</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">supervisor</span><span class="o">/</span><span class="n">conf</span><span class="p">.</span><span class="n">d</span> <span class="o">&amp;&amp;</span> <span class="n">echo_supervisord_conf</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">supervisor</span><span class="o">/</span><span class="n">supervisord</span><span class="p">.</span><span class="n">conf</span>
<span class="cp"># config scripts the last</span>
<span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">supervisord</span>
</pre></div>


<h3 id="2configmap">2.configmap</h3>
<div class="hlcode"><pre><span class="cp"># vim /etc/supervisor/supervisord.conf</span>
<span class="cp"># modify logfile and include</span>
<span class="n">logfile</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">supervisord</span><span class="p">.</span><span class="n">log</span>
<span class="p">[</span><span class="n">include</span><span class="p">]</span>
<span class="n">files</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">supervisor</span><span class="o">/</span><span class="n">conf</span><span class="p">.</span><span class="n">d</span><span class="o">/*</span><span class="p">.</span><span class="n">ini</span>
</pre></div>


<h3 id="3process-management">3.Process management</h3>
<div class="hlcode"><pre><span class="c1"># vim /etc/supervisor/conf.d/nginx-vts-exporter.ini</span>
<span class="k">[program:nginx-vts]</span>
<span class="na">command</span> <span class="o">=</span> <span class="s">/usr/local/bin/nginx-vts-exporter -nginx.scrape_uri=http://localhost/status/format/json</span>
<span class="na">autostart</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">startsecs</span> <span class="o">=</span> <span class="s">5</span>
<span class="na">redirect_stderr</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">stopasgroup</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">killasgroup</span> <span class="o">=</span> <span class="s">true</span>
</pre></div>


<h3 id="4start">4.start</h3>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">supervisord</span> <span class="n">restart</span>
<span class="n">supervisorctl</span> <span class="n">start</span> <span class="n">nginx</span><span class="o">-</span><span class="n">vts</span>
</pre></div>


<h3 id="centos6-script">Centos6 Script</h3>
<p>/etc/rc.d/init.d/supervisord</p>
<div class="hlcode"><pre><span class="c">#!/bin/bash</span>

. /etc/init.d/functions

<span class="nv">DAEMON</span><span class="o">=</span>/usr/bin/supervisord
<span class="nv">PIDFILE</span><span class="o">=</span>/var/run/supervisord.pid

<span class="o">[</span> -x <span class="s2">&quot;$DAEMON&quot;</span> <span class="o">]</span> <span class="o">||</span> <span class="nb">exit </span>0

start<span class="o">()</span> <span class="o">{</span>
        <span class="nb">echo</span> -n <span class="s2">&quot;Starting supervisord: &quot;</span>
        <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$PIDFILE</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">PID</span><span class="o">=</span><span class="sb">`</span>cat <span class="nv">$PIDFILE</span><span class="sb">`</span>
                <span class="nb">echo </span>supervisord already running: <span class="nv">$PID</span>
                <span class="nb">exit </span>2;
        <span class="k">else</span>
<span class="k">                </span>daemon  <span class="nv">$DAEMON</span> --pidfile<span class="o">=</span><span class="nv">$PIDFILE</span> -c /etc/supervisor/supervisord.conf
                <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
                <span class="nb">echo</span>
                <span class="o">[</span> <span class="nv">$RETVAL</span> -eq 0 <span class="o">]</span> <span class="o">&amp;&amp;</span> touch /var/lock/subsys/supervisord
                <span class="k">return</span> <span class="nv">$RETVAL</span>
        <span class="k">fi</span>

<span class="o">}</span>

stop<span class="o">()</span> <span class="o">{</span>
        <span class="nb">echo</span> -n <span class="s2">&quot;Shutting down supervisord: &quot;</span>
        <span class="nb">echo</span>
<span class="nb">        </span>killproc -p <span class="nv">$PIDFILE</span> supervisord
        <span class="nb">echo</span>
<span class="nb">        </span>rm -f /var/lock/subsys/supervisord
        <span class="k">return </span>0
<span class="o">}</span>

<span class="k">case</span> <span class="s2">&quot;$1&quot;</span> in
    start<span class="o">)</span>
        start
        ;;
    stop<span class="o">)</span>
        stop
        ;;
    status<span class="o">)</span>
        status supervisord
        ;;
    restart<span class="o">)</span>
        stop
        start
        ;;
    *<span class="o">)</span>
        <span class="nb">echo</span> <span class="s2">&quot;Usage:  {start|stop|status|restart}&quot;</span>
        <span class="nb">exit </span>1
        ;;
<span class="k">esac</span>
<span class="nb">exit</span> <span class="nv">$?</span>
</pre></div>


<h3 id="centos7-service">Centos7 Service</h3>
<p>/lib/systemd/system/supervisor.service</p>
<div class="hlcode"><pre><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">supervisor</span>
<span class="na">After</span><span class="o">=</span><span class="s">network.target</span>

<span class="k">[Service]</span>
<span class="na">Type</span><span class="o">=</span><span class="s">forking</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/bin/supervisord -c /etc/supervisord.conf</span>
<span class="na">ExecStop</span><span class="o">=</span><span class="s">/usr/bin/supervisorctl $OPTIONS shutdown</span>
<span class="na">ExecReload</span><span class="o">=</span><span class="s">/usr/bin/supervisorctl $OPTIONS reload</span>
<span class="na">KillMode</span><span class="o">=</span><span class="s">process</span>
<span class="na">Restart</span><span class="o">=</span><span class="s">on-failure</span>
<span class="na">RestartSec</span><span class="o">=</span><span class="s">42s</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>


<h3 id="command">command</h3>
<div class="hlcode"><pre><span class="cp"># Supervisor</span>
<span class="cp"># supervisord (start| stop)</span>
<span class="cp"># supervisorctl</span>
<span class="cp"># [program:nginx-vts] </span>
<span class="n">supervisorctl</span> <span class="n">start</span> <span class="n">nginx</span><span class="o">-</span><span class="n">vts</span>
<span class="n">supervisorctl</span> <span class="n">stop</span> <span class="n">nginx</span><span class="o">-</span><span class="n">vts</span>
<span class="n">supervisorctl</span> <span class="n">restart</span> <span class="n">nginx</span><span class="o">-</span><span class="n">vts</span>

<span class="cp"># stop，start，restart not overloading </span>
<span class="n">supervisorctl</span> <span class="n">stop</span> <span class="n">all</span> 

<span class="cp"># 重载配置文件，all 进程restart</span>
<span class="n">supervisorctl</span> <span class="n">reload</span>
<span class="cp"># new configmap，启动更新过配置的进程</span>
<span class="n">supervisorctl</span> <span class="n">update</span>
</pre></div>


<h3 id="annotation">Annotation</h3>
<div class="hlcode"><pre><span class="k">[unix_http_server]</span>
<span class="na">file</span><span class="o">=</span><span class="s">/tmp/supervisor.sock   ;UNIX socket 文件，supervisorctl 会使用</span>
<span class="c1">;chmod=0700                 ;socket文件的mode，默认是0700</span>
<span class="c1">;chown=nobody:nogroup       ;socket文件的owner，格式：uid:gid</span>

<span class="c1">;[inet_http_server]         ;HTTP服务器，提供web管理界面</span>
<span class="c1">;port=127.0.0.1:9001        ;Web管理后台运行的IP和端口，如果开放到公网，需要注意安全性</span>
<span class="c1">;username=user              ;登录管理后台的用户名</span>
<span class="c1">;password=123               ;登录管理后台的密码</span>

<span class="k">[supervisord]</span>
<span class="na">logfile</span><span class="o">=</span><span class="s">/tmp/supervisord.log ;日志文件，默认是 $CWD/supervisord.log</span>
<span class="na">logfile_maxbytes</span><span class="o">=</span><span class="s">50MB        ;日志文件大小，超出会rotate，默认 50MB，如果设成0，表示不限制大小</span>
<span class="na">logfile_backups</span><span class="o">=</span><span class="s">10           ;日志文件保留备份数量默认10，设为0表示不备份</span>
<span class="na">loglevel</span><span class="o">=</span><span class="s">info                ;日志级别，默认info，其它: debug,warn,trace</span>
<span class="na">pidfile</span><span class="o">=</span><span class="s">/tmp/supervisord.pid ;pid 文件</span>
<span class="na">nodaemon</span><span class="o">=</span><span class="s">false               ;是否在前台启动，默认是false，即以 daemon 的方式启动</span>
<span class="na">minfds</span><span class="o">=</span><span class="s">1024                  ;可以打开的文件描述符的最小值，默认 1024</span>
<span class="na">minprocs</span><span class="o">=</span><span class="s">200                 ;可以打开的进程数的最小值，默认 200</span>
<span class="na">user</span><span class="o">=</span> <span class="s">www                    ;设置启动supervisord 用户,默认root</span>

<span class="k">[supervisorctl]</span>
<span class="na">serverurl</span><span class="o">=</span><span class="s">unix:///tmp/supervisor.sock ;通过UNIX socket连接supervisord，路径与unix_http_server部分的file一致</span>
<span class="c1">;serverurl=http://127.0.0.1:9001 ; 通过HTTP的方式连接supervisord</span>

<span class="c1">; [program:xx]是被管理的进程配置参数，xx是进程的名称</span>
<span class="k">[program:xx]</span>
<span class="na">command</span><span class="o">=</span><span class="s">/opt/apache-tomcat-8.0.35/bin/catalina.sh run  ; 程序启动命令</span>
<span class="na">autostart</span><span class="o">=</span><span class="s">true       ; 在supervisord启动的时候也自动启动</span>
<span class="na">startsecs</span><span class="o">=</span><span class="s">10         ; 启动10秒后没有异常退出，就表示进程正常启动了，默认为1秒</span>
<span class="na">autorestart</span><span class="o">=</span><span class="s">true     ; 程序退出后自动重启,可选值：[unexpected,true,false]，默认为unexpected，表示进程意外杀死后才重启</span>
<span class="na">startretries</span><span class="o">=</span><span class="s">3       ; 启动失败自动重试次数，默认是3</span>
<span class="na">user</span><span class="o">=</span><span class="s">tomcat          ; 用哪个用户启动进程，默认是root</span>
<span class="na">priority</span><span class="o">=</span><span class="s">999         ; 进程启动优先级，默认999，值小的优先启动</span>
<span class="na">redirect_stderr</span><span class="o">=</span><span class="s">true ; 把stderr重定向到stdout，默认false</span>
<span class="na">stdout_logfile_maxbytes</span><span class="o">=</span><span class="s">20MB  ; stdout 日志文件大小，默认50MB</span>
<span class="na">stdout_logfile_backups</span> <span class="o">=</span> <span class="s">20   ; stdout 日志文件备份数，默认是10</span>
<span class="c1">; stdout 日志文件，需要注意当指定目录不存在时无法正常启动，所以需要手动创建目录（supervisord 会自动创建日志文件）</span>
<span class="na">stdout_logfile</span><span class="o">=</span><span class="s">/opt/apache-tomcat-8.0.35/logs/catalina.out</span>
<span class="na">stopasgroup</span><span class="o">=</span><span class="s">false     ;默认为false,进程被杀死时，是否向这个进程组发送stop信号，包括子进程</span>
<span class="na">killasgroup</span><span class="o">=</span><span class="s">false     ;默认为false，向进程组发送kill信号，包括子进程</span>
</pre></div>
  
</div>
    </div>
    <div id="footer">
      <div class="footer-left">
        <p>
        Copyright © 2019 Uxun.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
        Theme by <a href="https://github.com/tankywoo/yasimple_x2" target="_blank">YASimple_X2</a>.
        </p>
      </div> <!-- end footer-left -->
      <div class="footer-right">
        <p>Page Updated 2019-08-23 21:38:29</p>
      </div> <!-- end footer-right -->
    </div>

    
    

  </body>
</html>
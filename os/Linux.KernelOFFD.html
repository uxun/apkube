<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/colorful.css">
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/style.css">
    <link rel="shortcut icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>LinuxOF/FD - Uxun's WIKI</title>
    <meta name="keywords" content=""/>
    <meta name="description" content=""/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
  </head>

  <body>
    <div id="container" class="typo">
      
<div id="header">
  <div id="post-nav">
    <a href="/wiki/">Uxun's WIKI</a>
    &nbsp;&#187;&nbsp;
    <a href="/wiki/#os">os</a>
    &nbsp;&#187;&nbsp;LinuxOF/FD
    <span class="updated">Page Updated&nbsp;
    2019-08-21 13:00
    </span>
  </div>
</div>
<div class="clearfix"></div>
<div id="content">
  <h2 id="linux-maximum-number-of-open-files-file-descriptors-fd">Linux Maximum Number Of Open Files / File Descriptors (FD)</h2>
<blockquote>
<p>资源限制，linux最大文件描述符数，一个作用于内核(file-max)，一个作用于用户(RLIMIT_NOFILE)</p>
</blockquote>
<p><strong>几个关键词：</strong></p>
<p><strong><a href="http://man7.org/linux/man-pages/man5/proc.5.html">file-max</a></strong></p>
<blockquote>
<p>内核能打开的最大文件描述符数量为<code>/proc/sys/fs/file-max</code> 里的数值，服务器性能决定。</p>
</blockquote>
<div class="hlcode"><pre><span class="cp"># /etc/sysctl.conf </span>
<span class="n">fs</span><span class="p">.</span><span class="n">file</span><span class="o">-</span><span class="n">max</span><span class="o">=</span><span class="mi">790981</span>
</pre></div>


<p><strong><a href="http://man7.org/linux/man-pages/man2/getrlimit.2.html">RLIMIT_NOFILE</a></strong> </p>
<blockquote>
<p>定义进程可以打开的最大文件描述符数限制，不能超过<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=9cfe015aa424b3c003baba3841a60dd9b5ad319b">/proc/sys/fs /nr_open</a>。</p>
<p>root or capability(CAP_SYS_RESOURCE) 的进程，可以自由调整 RLIMIT_NOFILE 的软、硬限制。</p>
<p>limits.conf <a href="https://linux.die.net/man/5/limits.conf">文件的格式</a></p>
</blockquote>
<div class="hlcode"><pre><span class="cp"># ulimit -n</span>
<span class="cp"># 配置文件支持配置各个资源限制项的软、硬限制，支持从用户、用户组、全局三个层级进行配置</span>
<span class="cp"># ulimit -Sn &lt;= ulimit -Hn &lt;= cat /proc/sys/fs/nr_open</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">security</span><span class="o">/</span><span class="n">limits</span><span class="p">.</span><span class="n">conf</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">security</span><span class="o">/</span><span class="n">limits</span><span class="p">.</span><span class="n">d</span><span class="o">/*</span>
</pre></div>


<p><strong>修改运行中的进程资源限制的方式(kernel version ≥ 2.6.36)：</strong></p>
<ol>
<li>使用 <a href="https://linux.die.net/man/2/prlimit"><code>prlimit</code></a> (<a href="https://www.kernel.org/pub/linux/utils/util-linux/"><code>util-linux</code></a> ≥ 2.21) 修改指定进程的资源限制</li>
<li>直接修改进程对应的 <code>/proc/$PID/limits</code> 文件</li>
</ol>
<h3 id="systemd"><a href="https://wiki.archlinux.org/index.php/systemd_(简体中文)">Systemd</a></h3>
<p><a href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html#Process%20Properties">进程配置</a></p>
<blockquote>
<p>Centos7 中进程限制</p>
</blockquote>
<div class="hlcode"><pre><span class="cp"># service 文件中写入</span>
<span class="n">LimitNOFILE</span> <span class="o">=</span> <span class="mi">1048576</span>
</pre></div>


<h3 id="sysvinit"><a href="https://wiki.archlinux.org/index.php/SysVinit_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">SysVinit</a></h3>
<div class="hlcode"><pre><span class="c"># 启动脚本中执行 ulimit</span>
</pre></div>


<p><strong>ulimit command</strong></p>
<div class="hlcode"><pre><span class="na">-a</span><span class="err">：</span><span class="nx">显示目前资源限制的设定</span><span class="err">；</span>
<span class="na">-c</span> <span class="o">&lt;</span><span class="nx">core文件上限</span><span class="o">&gt;</span><span class="err">：</span><span class="nx">设定core文件的最大值</span><span class="err">，</span><span class="nx">单位为区块</span><span class="err">；</span>
<span class="na">-d</span> <span class="o">&lt;</span><span class="nx">数据节区大小</span><span class="o">&gt;</span><span class="err">：</span><span class="nx">程序数据节区的最大值</span><span class="err">，</span><span class="nx">单位为KB</span><span class="err">；</span>
<span class="na">-f</span> <span class="o">&lt;</span><span class="nx">文件大小</span><span class="o">&gt;</span><span class="err">：</span><span class="nx">shell所能建立的最大文件</span><span class="err">，</span><span class="nx">单位为区块</span><span class="err">；</span>
<span class="na">-H</span><span class="err">：</span><span class="nx">设定资源的硬性限制</span><span class="err">，</span><span class="nx">也就是管理员所设下的限制</span><span class="err">；</span>
<span class="na">-m</span> <span class="o">&lt;</span><span class="nx">内存大小</span><span class="o">&gt;</span><span class="err">：</span><span class="nx">指定可使用内存的上限</span><span class="err">，</span><span class="nx">单位为KB</span><span class="err">；</span>
<span class="na">-n</span> <span class="o">&lt;</span><span class="nx">文件数目</span><span class="o">&gt;</span><span class="err">：</span><span class="nx">指定同一时间最多可开启的文件数</span><span class="err">；</span>
<span class="na">-p</span> <span class="o">&lt;</span><span class="nx">缓冲区大小</span><span class="o">&gt;</span><span class="err">：</span><span class="nx">指定管道缓冲区的大小</span><span class="err">，</span><span class="nx">单位512字节</span><span class="err">；</span>
<span class="na">-s</span> <span class="o">&lt;</span><span class="nx">堆叠大小</span><span class="o">&gt;</span><span class="err">：</span><span class="nx">指定堆叠的上限</span><span class="err">，</span><span class="nx">单位为KB</span><span class="err">；</span>
<span class="na">-S</span><span class="err">：</span><span class="nx">设定资源的弹性限制</span><span class="err">；</span>
<span class="na">-t</span> <span class="o">&lt;</span><span class="nx">CPU时间</span><span class="o">&gt;</span><span class="err">：</span><span class="nx">指定CPU使用时间的上限</span><span class="err">，</span><span class="nx">单位为秒</span><span class="err">；</span>
<span class="na">-u</span> <span class="o">&lt;</span><span class="nx">程序数目</span><span class="o">&gt;</span><span class="err">：</span><span class="nx">用户最多可开启的程序数目</span><span class="err">；</span>
<span class="na">-v</span> <span class="o">&lt;</span><span class="nx">虚拟内存大小</span><span class="o">&gt;</span><span class="err">：</span><span class="nx">指定可使用的虚拟内存上限</span><span class="err">，</span><span class="nx">单位为KB</span><span class="err">。</span>
</pre></div>


<p><strong>info</strong></p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">ulimit</span> <span class="o">-</span><span class="n">a</span>
<span class="n">core</span> <span class="n">file</span> <span class="n">size</span>          <span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="o">-</span><span class="n">c</span><span class="p">)</span> <span class="mi">0</span>           <span class="err">#</span><span class="n">core</span><span class="err">文件的最大值为</span><span class="mi">100</span> <span class="n">blocks</span><span class="err">。</span>
<span class="n">data</span> <span class="n">seg</span> <span class="n">size</span>           <span class="p">(</span><span class="n">kbytes</span><span class="p">,</span> <span class="o">-</span><span class="n">d</span><span class="p">)</span> <span class="n">unlimited</span>   <span class="err">#进程的数据段可以任意大。</span>
<span class="n">scheduling</span> <span class="n">priority</span>             <span class="p">(</span><span class="o">-</span><span class="n">e</span><span class="p">)</span> <span class="mi">0</span>
<span class="n">file</span> <span class="n">size</span>               <span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="o">-</span><span class="n">f</span><span class="p">)</span> <span class="n">unlimited</span>   <span class="err">#文件可以任意大。</span>
<span class="n">pending</span> <span class="n">signals</span>                 <span class="p">(</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="mi">98304</span>       <span class="err">#最多有</span><span class="mi">98304</span><span class="err">个待处理的信号。</span>
<span class="n">max</span> <span class="n">locked</span> <span class="n">memory</span>       <span class="p">(</span><span class="n">kbytes</span><span class="p">,</span> <span class="o">-</span><span class="n">l</span><span class="p">)</span> <span class="mi">32</span>          <span class="err">#一个任务锁住的物理内存的最大值为</span><span class="mi">32</span><span class="n">KB</span><span class="err">。</span>
<span class="n">max</span> <span class="n">memory</span> <span class="n">size</span>         <span class="p">(</span><span class="n">kbytes</span><span class="p">,</span> <span class="o">-</span><span class="n">m</span><span class="p">)</span> <span class="n">unlimited</span>   <span class="err">#一个任务的常驻物理内存的最大值。</span>
<span class="n">open</span> <span class="n">files</span>                      <span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">)</span> <span class="mi">1024</span>        <span class="err">#一个任务最多可以同时打开</span><span class="mi">1024</span><span class="err">的文件。</span>
<span class="n">pipe</span> <span class="n">size</span>            <span class="p">(</span><span class="mi">512</span> <span class="n">bytes</span><span class="p">,</span> <span class="o">-</span><span class="n">p</span><span class="p">)</span> <span class="mi">8</span>           <span class="err">#管道的最大空间为</span><span class="mi">4096</span><span class="err">字节。</span>
<span class="n">POSIX</span> <span class="n">message</span> <span class="n">queues</span>     <span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="o">-</span><span class="n">q</span><span class="p">)</span> <span class="mi">819200</span>      <span class="err">#</span><span class="n">POSIX</span><span class="err">的消息队列的最大值为</span><span class="mi">819200</span><span class="err">字节。</span>
<span class="n">real</span><span class="o">-</span><span class="n">time</span> <span class="n">priority</span>              <span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="p">)</span> <span class="mi">0</span>
<span class="n">stack</span> <span class="n">size</span>              <span class="p">(</span><span class="n">kbytes</span><span class="p">,</span> <span class="o">-</span><span class="n">s</span><span class="p">)</span> <span class="mi">10240</span>       <span class="err">#进程的栈的最大值为</span><span class="mi">10240</span><span class="err">字节。</span>
<span class="n">cpu</span> <span class="n">time</span>               <span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="o">-</span><span class="n">t</span><span class="p">)</span> <span class="n">unlimited</span>   <span class="err">#进程使用的</span><span class="n">CPU</span><span class="err">时间。</span>
<span class="n">max</span> <span class="n">user</span> <span class="n">processes</span>              <span class="p">(</span><span class="o">-</span><span class="n">u</span><span class="p">)</span> <span class="mi">98304</span>       <span class="err">#当前用户同时打开的进程（包括线程）的最大个数为</span><span class="mi">98304</span><span class="err">。</span>
<span class="n">virtual</span> <span class="n">memory</span>          <span class="p">(</span><span class="n">kbytes</span><span class="p">,</span> <span class="o">-</span><span class="n">v</span><span class="p">)</span> <span class="n">unlimited</span>   <span class="err">#没有限制进程的最大地址空间。</span>
<span class="n">file</span> <span class="n">locks</span>                      <span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="n">unlimited</span>   <span class="err">#所能锁住的文件的最大个数没有限制。</span>
</pre></div>


<h3 id="refernece">REFERNECE</h3>
<p><a href="https://leokongwq.github.io/2016/11/09/linux-max-fd.html">https://leokongwq.github.io/2016/11/09/linux-max-fd.html</a></p>
<p><a href="https://wweir.cc/post/资源限制rlimit_nofile的调整细节及内部实现/">https://wweir.cc/post/资源限制rlimit_nofile的调整细节及内部实现/</a></p>
<p><a href="https://segmentfault.com/a/1190000009724931">https://segmentfault.com/a/1190000009724931</a></p>
  
</div>
    </div>
    <div id="footer">
      <div class="footer-left">
        <p>
        Copyright © 2019 Uxun.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
        Theme by <a href="https://github.com/tankywoo/yasimple_x2" target="_blank">YASimple_X2</a>.
        </p>
      </div> <!-- end footer-left -->
      <div class="footer-right">
        <p>Page Updated 2019-09-30 14:39:58</p>
      </div> <!-- end footer-right -->
    </div>

    
    

  </body>
</html>
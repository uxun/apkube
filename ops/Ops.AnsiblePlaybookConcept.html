<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/colorful.css">
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/style.css">
    <link rel="shortcut icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>ApbConcept - Uxun's WIKI</title>
    <meta name="keywords" content=""/>
    <meta name="description" content=""/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
  </head>

  <body>
    <div id="container" class="typo">
      
<div id="header">
  <div id="post-nav">
    <a href="/wiki/">Uxun's WIKI</a>
    &nbsp;&#187;&nbsp;
    <a href="/wiki/#ops">ops</a>
    &nbsp;&#187;&nbsp;ApbConcept
    <span class="updated">Page Updated&nbsp;
    
    </span>
  </div>
</div>
<div class="clearfix"></div>
<div id="content">
  <h1 id="ansible-playbook-concept">Ansible Playbook Concept</h1>
<blockquote>
<p>剧本</p>
</blockquote>
<h3 id="core">Core：</h3>
<ul>
<li>hosts：主机</li>
<li>tasks：任务列表</li>
<li>vars：变量优先级高于defaults目录中的变量</li>
<li>templates：包含了模板语法的文本文件；</li>
<li>handlers：由特定条件触发的任务；</li>
<li>meta:  特殊任务，影响ansible内部执行或状态</li>
<li>roles：角色 实现代码复用</li>
<li>defaults：为当前角色定义默认变量使用此目录，包含一个main.yml</li>
</ul>
<p><strong>语法检查</strong></p>
<div class="hlcode"><pre><span class="cp"># 语法验证</span>
<span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">--</span><span class="n">syntax</span><span class="o">-</span><span class="n">check</span> <span class="n">name</span><span class="p">.</span><span class="n">yml</span>

<span class="cp"># 模拟playbook</span>
<span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">--</span><span class="n">check</span> <span class="n">name</span><span class="p">.</span><span class="n">yml</span>
</pre></div>


<p><strong>YAML语法</strong></p>
<div class="hlcode"><pre><span class="gd">--- # Start 只能空格缩进</span>
<span class="gd">- hosts: host1,host2,host3 # 块序列节点</span>
  remote_user: root # root执行
  tasks: # 冒号后跟空格
  - name: Ping
    ping:
</pre></div>


<h3 id="1">1.目录固定格式</h3>
<div class="hlcode"><pre><span class="n">roles</span><span class="o">/</span>
<span class="err">└──</span> <span class="n">chronyc</span>             <span class="o">--</span><span class="err">#</span> <span class="err">角色同目录名</span>
    <span class="err">├──</span> <span class="n">defaults</span>        <span class="o">--</span><span class="err">#</span> <span class="err">用于为当前角色设定的默认变量</span>
    <span class="err">│</span>   <span class="err">└──</span> <span class="n">main</span><span class="p">.</span><span class="n">yml</span>    <span class="o">--</span><span class="err">#</span> <span class="err">至少有一个</span><span class="n">main</span><span class="p">.</span><span class="n">yml</span><span class="err">文件</span>
    <span class="err">├──</span> <span class="n">file</span>            <span class="o">--</span><span class="err">#</span> <span class="err">安装文件所在目录</span><span class="p">(</span><span class="n">copy</span><span class="o">|</span><span class="n">script</span><span class="p">)</span><span class="err">调用</span>
    <span class="err">├──</span> <span class="n">handlers</span>        <span class="o">--</span><span class="err">#</span> <span class="err">特定任务满足后条件触发的任务</span>
    <span class="err">│</span>   <span class="err">└──</span> <span class="n">main</span><span class="p">.</span><span class="n">yml</span>
    <span class="err">├──</span> <span class="n">meta</span>            <span class="o">--</span><span class="err">#</span> <span class="err">用于定义此角色的社特殊设定及其依赖关系</span>
    <span class="err">│</span>   <span class="err">└──</span> <span class="n">main</span><span class="p">.</span><span class="n">yml</span>
    <span class="err">├──</span> <span class="n">tasks</span>           <span class="o">--</span><span class="err">#</span> <span class="err">此角色任务列表文件</span>
    <span class="err">│</span>   <span class="err">└──</span> <span class="n">main</span><span class="p">.</span><span class="n">yml</span>
    <span class="err">├──</span> <span class="n">templates</span>       <span class="o">--</span><span class="err">#</span> <span class="err">存放</span><span class="n">jinja2</span><span class="err">模板文件</span>
    <span class="err">└──</span> <span class="n">vars</span>            <span class="o">--</span><span class="err">#</span> <span class="err">用于定义此角色用到的变量</span>
        <span class="err">└──</span> <span class="n">main</span><span class="p">.</span><span class="n">yml</span>
</pre></div>


<h2 id="2playbook">2.playbook 逻辑控制语句</h2>
<ul>
<li>when：条件判断语句，类似shell if</li>
<li>loop：循环语句，类似shell while</li>
<li>block：把几个tasks组成一块代码，针对异常处理操作</li>
</ul>
<h2 id="3-special-variables">3.魔术变量 <a href="https://docs.ansible.com/ansible/latest/reference_appendices/special_variables.html">Special Variables</a></h2>
<p><strong>1.hostvars</strong></p>
<blockquote>
<p>hostvars 使用当前主机获取其他主机变量，包括主机中获取额facts，需要先获取其他主机的Gathering Facts信息才能捕获其对应的内置变量</p>
<p>gather_facts: no 表示不收集对应主机信息，115主机无法收集116主机信息</p>
</blockquote>
<div class="hlcode"><pre><span class="o">---</span>
<span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="s">&quot;no.1 facts 116&quot;</span>
  <span class="nl">hosts:</span> <span class="mf">192.168.1.116</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">gather_facts:</span> <span class="n">no</span>
<span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="s">&quot;no.2 facts 115&quot;</span>
  <span class="nl">hosts:</span> <span class="mf">192.168.1.115</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">debug</span><span class="o">:</span> 
      <span class="n">msg</span><span class="o">:</span> <span class="s">&quot;{{hostvars[&#39;192.168.1.116&#39;].ansible_ens160.ipv4}}&quot;</span>

<span class="n">TASK</span> <span class="p">[</span><span class="n">debug</span><span class="p">]</span> <span class="o">**************************************************************************************************</span>
<span class="nl">ok:</span> <span class="p">[</span><span class="mf">192.168.1.115</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s">&quot;msg&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s">&quot;address&quot;</span><span class="o">:</span> <span class="s">&quot;192.168.1.116&quot;</span><span class="p">,</span>
        <span class="s">&quot;broadcast&quot;</span><span class="o">:</span> <span class="s">&quot;192.168.1.255&quot;</span><span class="p">,</span>
        <span class="s">&quot;netmask&quot;</span><span class="o">:</span> <span class="s">&quot;255.255.255.0&quot;</span><span class="p">,</span>
        <span class="s">&quot;network&quot;</span><span class="o">:</span> <span class="s">&quot;192.168.1.0&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p><strong>2.inventory_hostname | play_hosts</strong></p>
<blockquote>
<p>获取配置清单中的主机名称</p>
<p>inventory_hostname 只返回hosts中对应的值</p>
<p>inventory_hostname_short 获取简短名称</p>
<p>inventory_dir：获取清单hosts存放路径</p>
</blockquote>
<div class="hlcode"><pre><span class="cp"># 获取当前被操作的主机地址</span>
<span class="n">ansible</span> <span class="n">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">debug</span> <span class="o">-</span><span class="n">a</span> <span class="err">&#39;</span><span class="n">msg</span><span class="o">=</span><span class="p">{{</span><span class="n">inventory_hostname</span><span class="p">}}</span><span class="err">&#39;</span>

<span class="cp"># 获取当前主机的主机名list，不推荐使用与ansible_play_batch相同</span>
<span class="n">ansible</span> <span class="n">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">debug</span> <span class="o">-</span><span class="n">a</span> <span class="err">&#39;</span><span class="n">msg</span><span class="o">=</span><span class="p">{{</span><span class="n">play_hosts</span><span class="p">}}</span><span class="err">&#39;</span>
</pre></div>


<p><strong>3.groups</strong></p>
<blockquote>
<p>内置主机变量，所有列表元素</p>
<p>-i: 指定库存路径</p>
<p>groups_names：获取hosts组名</p>
<p>groups_ungrouped：获取未分组的组名</p>
</blockquote>
<div class="hlcode"><pre><span class="cp"># &quot;var=hostvars[groups[&#39;kube-node&#39;][0]]&quot;</span>
<span class="cp"># {{ groups[&#39;one&#39;] }}</span>
<span class="cp"># {{ groups.one }}</span>
<span class="n">ansible</span> <span class="o">-</span><span class="n">i</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">hosts</span> <span class="n">localhost</span> <span class="o">-</span><span class="n">m</span> <span class="n">debug</span> <span class="o">-</span><span class="n">a</span> <span class="s">&quot;var=hostvars[groups.etcd[0]]&quot;</span>
</pre></div>


<h2 id="jinja2">Jinja2 模板</h2>
<p><strong>语法</strong></p>
<p>{{ 表达式(变量，运算表达式，比较表达式) }}</p>
<p>{% 控制语句(if，for) %}</p>
<p>{# 注释(文件渲染后，注释不会生成) #}</p>
<div class="hlcode"><pre><span class="cp"># 比较</span>
<span class="p">{{</span> <span class="n">test</span> <span class="n">is</span> <span class="n">defined</span><span class="p">}}</span>
<span class="p">{{</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">data</span><span class="err">&#39;</span> <span class="n">is</span> <span class="n">exists</span> <span class="p">}}</span>
<span class="cp"># 变量</span>
<span class="p">[</span><span class="n">client</span><span class="p">]</span>
<span class="n">port</span> <span class="o">=</span> <span class="p">{{</span> <span class="n">mysql_port</span> <span class="p">}}</span>
<span class="n">socket</span> <span class="o">=</span> <span class="p">{{</span> <span class="n">mysql_socket</span> <span class="p">}}</span>
<span class="cp"># 运算</span>
<span class="p">{{</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">and</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">}}</span>
</pre></div>


<p>控制语句</p>
<div class="hlcode"><pre><span class="x"># if end</span>
<span class="cp">{%</span> <span class="k">if</span> <span class="p">条件</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">...</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>

<span class="x"># if else</span>
<span class="cp">{%</span> <span class="k">if</span> <span class="p">条件</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">...</span>
<span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">...</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>

<span class="x"># if else if</span>
<span class="cp">{%</span> <span class="k">if</span> <span class="p">条件</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">...</span>
<span class="cp">{%</span> <span class="k">elif</span> <span class="p">条件</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">...</span>
<span class="cp">{%</span> <span class="k">elif</span> <span class="p">条件</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">...</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>

<span class="x"># e.g</span>
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">i</span> <span class="k">in</span> <span class="o">[</span><span class="m">1</span><span class="o">,</span><span class="m">2</span><span class="o">,</span><span class="m">3</span><span class="o">,</span><span class="m">4</span><span class="o">,</span><span class="m">5</span><span class="o">]</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{{</span> <span class="nv">i</span> <span class="cp">}}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">end: </span>
<span class="x">1</span>
<span class="x">2</span>
<span class="x">3</span>
<span class="x">4</span>
<span class="x">5</span>

<span class="x"># 带有 &quot;-&quot; 符号</span>
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">i</span> <span class="k">in</span> <span class="o">[</span><span class="m">1</span><span class="o">,</span><span class="m">2</span><span class="o">,</span><span class="m">3</span><span class="o">,</span><span class="m">4</span><span class="o">,</span><span class="m">5</span><span class="o">]</span> -<span class="cp">%}</span><span class="x"></span>
<span class="cp">{{</span> <span class="nv">i</span> <span class="cp">}}</span><span class="x"></span>
<span class="cp">{%</span>- <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">end: 12345</span>

<span class="x"># 带空格</span>
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">i</span> <span class="k">in</span> <span class="o">[</span><span class="m">1</span><span class="o">,</span><span class="m">2</span><span class="o">,</span><span class="m">3</span><span class="o">,</span><span class="m">4</span><span class="o">,</span><span class="m">5</span><span class="o">]</span> -<span class="cp">%}</span><span class="x"></span>
<span class="cp">{{</span> <span class="nv">i</span> <span class="cp">}}{{</span><span class="s1">&#39;&#39;</span><span class="cp">}}</span><span class="x"></span>
<span class="cp">{%</span>- <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">end: 1 2 3 4 5</span>

<span class="x"># 波浪符号&quot;~&quot; 将字符串连接一起</span>
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">i</span> <span class="k">in</span> <span class="o">[</span><span class="m">1</span><span class="o">,</span><span class="m">2</span><span class="o">,</span><span class="m">3</span><span class="o">,</span><span class="m">4</span><span class="o">,</span><span class="m">5</span><span class="o">]</span> -<span class="cp">%}</span><span class="x"></span>
<span class="cp">{{</span> <span class="nv">i</span><span class="o">~</span><span class="s1">&#39;&#39;</span><span class="cp">}}</span><span class="x"></span>
<span class="cp">{%</span>- <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">end: 1 2 3 4 5</span>
</pre></div>


<p>转义</p>
<div class="hlcode"><pre><span class="p">{{</span><span class="err">&#39;</span><span class="p">{{</span><span class="err">&#39;</span><span class="p">}}</span>  <span class="o">--</span> <span class="o">&gt;</span>  <span class="p">{{</span>
<span class="p">{{</span><span class="err">&#39;</span><span class="p">{{</span><span class="n">string</span><span class="p">}}</span><span class="err">&#39;</span><span class="p">}}</span> <span class="o">---&gt;</span> <span class="p">{{</span><span class="n">string</span><span class="p">}}</span>

<span class="cp"># 不被jinja2解析</span>
<span class="p">{</span><span class="o">%</span> <span class="n">raw</span> <span class="o">%</span><span class="p">}</span>
 <span class="p">{{</span> <span class="n">test</span> <span class="p">}}</span>
 <span class="p">{</span><span class="o">%</span> <span class="n">hello</span> <span class="o">%</span><span class="p">}</span>
 <span class="p">{</span><span class="err">#</span> <span class="n">world</span> <span class="err">#</span><span class="p">}</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endraw</span> <span class="o">%</span><span class="p">}</span>
<span class="nl">end:</span>
 <span class="p">{{</span> <span class="n">test</span> <span class="p">}}</span>
 <span class="p">{</span><span class="o">%</span> <span class="n">hello</span> <span class="o">%</span><span class="p">}</span>
 <span class="p">{</span><span class="err">#</span> <span class="n">world</span> <span class="err">#</span><span class="p">}</span>
</pre></div>


<p>宏相关</p>
<div class="hlcode"><pre><span class="p">{</span><span class="o">%</span> <span class="n">macro</span> <span class="n">func</span><span class="p">()</span> <span class="o">%</span><span class="p">}</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endmacro</span> <span class="o">%</span><span class="p">}</span>
</pre></div>


<p>嵌套</p>
<div class="hlcode"><pre><span class="cp"># 1.j2</span>
<span class="p">{</span><span class="o">%</span><span class="n">include</span> <span class="err">&#39;</span><span class="mf">2.</span><span class="n">j2</span><span class="err">&#39;</span><span class="o">%</span><span class="p">}</span>
<span class="n">test</span>
<span class="p">..</span>

<span class="cp"># 2.j2</span>
<span class="p">{</span><span class="o">%</span><span class="k">for</span> <span class="n">in</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">%</span><span class="p">}</span>
<span class="p">{{</span><span class="n">i</span><span class="p">}}</span>
<span class="p">{</span><span class="o">%</span><span class="n">endfor</span><span class="o">%</span><span class="p">}</span>
</pre></div>


<p>继承</p>
<div class="hlcode"><pre><span class="cp">{%</span> <span class="k">block</span> <span class="nv">test</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">...</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="nv">test</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
  
</div>
    </div>
    <div id="footer">
      <div class="footer-left">
        <p>
        Copyright © 2019 Uxun.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
        Theme by <a href="https://github.com/tankywoo/yasimple_x2" target="_blank">YASimple_X2</a>.
        </p>
      </div> <!-- end footer-left -->
      <div class="footer-right">
        <p>Page Updated 2019-09-20 11:56:16</p>
      </div> <!-- end footer-right -->
    </div>

    
    

  </body>
</html>
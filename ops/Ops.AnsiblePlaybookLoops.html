<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/colorful.css">
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/style.css">
    <link rel="shortcut icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>ApbLoops - Uxun's WIKI</title>
    <meta name="keywords" content=""/>
    <meta name="description" content=""/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
  </head>

  <body>
    <div id="container" class="typo">
      
<div id="header">
  <div id="post-nav">
    <a href="/wiki/">Uxun's WIKI</a>
    &nbsp;&#187;&nbsp;
    <a href="/wiki/#ops">ops</a>
    &nbsp;&#187;&nbsp;ApbLoops
    <span class="updated">Page Updated&nbsp;
    
    </span>
  </div>
</div>
<div class="clearfix"></div>
<div id="content">
  <h1 id="ansible-playbook-loops">Ansible Playbook Loops</h1>
<table>
<thead>
<tr>
<th><strong>with_list</strong></th>
<th><strong>with_flattened</strong></th>
<th><strong>with_together</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>with_cartesian</strong></td>
<td><strong>with_indexed_items</strong></td>
<td><strong>with_flattened</strong></td>
</tr>
<tr>
<td><strong>with_sequence</strong></td>
<td><strong>with_random_choice</strong></td>
<td><strong>with_dict</strong></td>
</tr>
<tr>
<td><strong>with_file</strong></td>
<td><strong>with_fileglo</strong></td>
<td></td>
</tr>
</tbody>
</table>
<p><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html#with-dict">REFERNECE</a></p>
<blockquote>
<p>循环处理返回信息,指定操作主机处理</p>
</blockquote>
<h3 id="with_items">with_items:</h3>
<blockquote>
<p>遍历数组</p>
<p>with_flattened: 同 with_items</p>
</blockquote>
<div class="hlcode"><pre><span class="o">---</span>
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">gather_facts:</span> <span class="n">no</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
      <span class="nl">msg:</span> <span class="s">&quot;{{ item }}&quot;</span>
    <span class="nl">with_items:</span> <span class="s">&quot;{{groups.etcd}}&quot;</span>

<span class="cp"># 格式</span>
<span class="cp"># one的值为a, etcd的值为1。输出为a,2</span>
<span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
   <span class="nl">msg:</span> <span class="s">&quot;{{ item.one}}&quot;</span>
  <span class="nl">with_items:</span>
  <span class="o">-</span> <span class="p">{</span> <span class="n">one</span><span class="o">:</span> <span class="n">a</span><span class="p">,</span> <span class="n">etcd</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span> <span class="n">one</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">etcd</span><span class="o">:</span> <span class="mi">3</span> <span class="p">}</span>

<span class="cp"># e.g</span>
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">vars:</span>
    <span class="nl">dirs:</span> <span class="p">[</span><span class="s">&quot;/data/a&quot;</span><span class="p">,</span><span class="s">&quot;/data/b&quot;</span><span class="p">]</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">file</span><span class="o">:</span>
     <span class="nl">path:</span> <span class="s">&quot;{{item}}&quot;</span>
     <span class="nl">state:</span> <span class="n">touch</span>
    <span class="nl">with_items:</span> <span class="s">&quot;{{dirs}}&quot;</span>

<span class="cp"># e.g register</span>
<span class="cp"># 返回值放入 results 序列中，可通过results关键字获取返回值</span>
<span class="o">---</span>
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">gather_facts:</span> <span class="n">no</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">shell</span><span class="o">:</span> <span class="s">&quot;{{item}}&quot;</span> 
    <span class="n">with_items</span><span class="o">:</span>
    <span class="o">-</span> <span class="s">&quot;ls /data&quot;</span>
    <span class="o">-</span> <span class="s">&quot;ls /root&quot;</span>
    <span class="nl">register:</span> <span class="n">rue</span>
  <span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
     <span class="nl">msg:</span> <span class="s">&quot;{{item.stdout}}&quot;</span>
    <span class="nl">with_items:</span> <span class="s">&quot;{{rue.results}}&quot;</span>
</pre></div>


<h3 id="with_list">with_list</h3>
<blockquote>
<p>将外层列作为一组输出</p>
</blockquote>
<div class="hlcode"><pre><span class="err">#</span> <span class="nt">e</span><span class="nc">.g</span> <span class="nt">with_list</span> <span class="err">将数组中作为</span><span class="nt">debug</span><span class="err">一个小整体输出</span>
<span class="nt">---</span>
<span class="nt">-</span> <span class="nt">hosts</span><span class="o">:</span> <span class="nt">one</span>
  <span class="nt">tasks</span><span class="o">:</span>
  <span class="nt">-</span> <span class="nt">debug</span><span class="o">:</span>
      <span class="nt">msg</span><span class="o">:</span> <span class="s2">&quot;{{item}}&quot;</span>
    <span class="nt">with_list</span><span class="o">:</span>
    <span class="nt">-</span> <span class="cp">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="cp">]</span>
    <span class="nt">-</span> <span class="cp">[</span><span class="nx">ha</span><span class="p">,</span><span class="nx">ah</span><span class="p">,</span><span class="nx">hah</span><span class="cp">]</span>
<span class="nt">TASK</span> <span class="cp">[</span><span class="nb">debug</span><span class="cp">]</span> <span class="o">******************************************************************************************************************************</span>
<span class="nt">ok</span><span class="o">:</span> <span class="cp">[</span><span class="mf">192.168.1.116</span><span class="cp">]</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="nt">item</span><span class="o">=</span><span class="cp">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="cp">]</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s2">&quot;msg&quot;</span><span class="o">:</span> <span class="cp">[</span>
        <span class="mi">1</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">,</span>
        <span class="mi">3</span>
    <span class="cp">]</span>
<span class="p">}</span>
<span class="nt">ok</span><span class="o">:</span> <span class="cp">[</span><span class="mf">192.168.1.116</span><span class="cp">]</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="nt">item</span><span class="o">=</span><span class="cp">[</span><span class="nx">u</span><span class="s1">&#39;ha&#39;</span><span class="p">,</span> <span class="nx">u</span><span class="s1">&#39;ah&#39;</span><span class="p">,</span> <span class="nx">u</span><span class="s1">&#39;hah&#39;</span><span class="cp">]</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s2">&quot;msg&quot;</span><span class="o">:</span> <span class="cp">[</span>
        <span class="s2">&quot;ha&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ah&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hah&quot;</span>
    <span class="cp">]</span>
<span class="p">}</span>
</pre></div>


<h3 id="with_together">with_together</h3>
<blockquote>
<p>将两个列表中的元素对齐合并</p>
</blockquote>
<div class="hlcode"><pre><span class="gd">--- </span>
<span class="gd">- hosts: one</span>
  remote_user: root
  gather_facts: no
  tasks:
  - debug:
     msg: &#39;{{item}}&#39;
    whit_together:
    - [a,b,c]
    - [d,e,f]

# The results of ad,bc,cf
</pre></div>


<h3 id="with_cartesian">with_cartesian</h3>
<blockquote>
<p>类似笛卡尔乘积，将列1中的元素与列2中的元素两两组合</p>
</blockquote>
<div class="hlcode"><pre><span class="cp"># e.g with_cartesian:</span>
<span class="o">---</span>
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">file</span><span class="o">:</span>
     <span class="nl">state:</span> <span class="n">directory</span>
     <span class="nl">path:</span> <span class="s">&quot;/data/{{item.0}}/{{item.1}}&quot;</span>
    <span class="nl">with_cartesian:</span>
    <span class="o">-</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
    <span class="o">-</span> <span class="p">[</span><span class="mf">4.5.6</span><span class="p">]</span>

<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">ap</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="mi">116</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">ls</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span>
<span class="mi">1</span>  <span class="mi">2</span>  <span class="mi">3</span> 
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">ap</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="mi">116</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">ls</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span>
<span class="mi">4</span><span class="o">/</span> <span class="mi">5</span><span class="o">/</span> <span class="mi">6</span><span class="o">/</span>
</pre></div>


<h3 id="with_indexed_items">with_indexed_items</h3>
<blockquote>
<p>循环处理列表时候为列表中每一项添加"数字索引，0开始计数" 多列表情况类似with_flattened</p>
</blockquote>
<div class="hlcode"><pre><span class="cp"># 数字索引，0开始计数</span>
<span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
   <span class="nl">msg:</span> <span class="err">&#39;</span><span class="p">{{</span><span class="n">item</span><span class="p">}}</span><span class="err">&#39;</span>
  <span class="nl">with_indexed_items:</span>
  <span class="o">-</span> <span class="n">a</span>
  <span class="o">-</span> <span class="n">b</span>
  <span class="o">-</span> <span class="n">c</span>

<span class="cp"># The results of 0a,1b,2c</span>
</pre></div>


<h3 id="with_sequence">with_sequence</h3>
<blockquote>
<p>指定模块循环 tip：format:指定数据输出的格式</p>
</blockquote>
<div class="hlcode"><pre><span class="cp"># e.g with_sequence 模块循环调用，通过sequence顺序生成数字序列 </span>
<span class="cp"># start=1开始 end=3结束 stride=1步长 同等于 count=3</span>
<span class="o">---</span> 
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
     <span class="nl">msg:</span> <span class="p">{{</span><span class="n">item</span><span class="p">}}</span>
    <span class="nl">with_sequence:</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span> <span class="n">end</span><span class="o">=</span><span class="mi">3</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
    <span class="err">#</span> <span class="n">with_sequence</span><span class="o">:</span> <span class="n">count</span><span class="o">=</span><span class="mi">3</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;number is %0.2f&quot;</span> <span class="o">%</span><span class="mf">0.2f</span><span class="o">:</span><span class="err">保留两位小数点的浮点数</span>
    <span class="err">#</span> <span class="n">with_sequence</span><span class="o">:</span> <span class="n">start</span><span class="o">=</span><span class="mi">6</span> <span class="n">end</span><span class="o">=</span><span class="mi">2</span> <span class="n">stride</span><span class="o">=-</span><span class="mi">2</span> <span class="err">数字</span><span class="mi">6</span><span class="err">开始，每次递减</span><span class="mi">2</span><span class="err">，到</span><span class="mi">2</span><span class="err">结束</span>
</pre></div>


<h3 id="with_random_choice">with_random_choice</h3>
<blockquote>
<p>列表中随机返回值</p>
</blockquote>
<div class="hlcode"><pre><span class="nl">tasks:</span>
<span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
   <span class="nl">msg:</span> <span class="err">&#39;</span><span class="p">{{</span><span class="n">item</span><span class="p">}}</span><span class="err">&#39;</span>
  <span class="nl">with_random_choice:</span>
  <span class="o">-</span> <span class="mi">1</span>
  <span class="o">-</span> <span class="mi">2</span>
  <span class="o">-</span> <span class="mi">3</span>
</pre></div>


<h3 id="with_dict">with_dict</h3>
<blockquote>
<p>处理字典键值对</p>
</blockquote>
<div class="hlcode"><pre><span class="cp"># e.g with_dict key=tony value:name,gender,telephone</span>
<span class="o">---</span>
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">vars:</span>
   <span class="nl">users:</span>
     <span class="nl">tony:</span>
      <span class="nl">name:</span> <span class="n">sssxun</span>
      <span class="nl">gender:</span> <span class="n">female</span>
      <span class="nl">telephone:</span> <span class="mi">133</span>
     <span class="nl">cact:</span>
      <span class="nl">name:</span> <span class="n">zzzhong</span>
      <span class="nl">gender:</span> <span class="n">male</span>
      <span class="nl">telephone:</span> <span class="mi">122</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
     <span class="nl">msg:</span> <span class="s">&quot;{{item}}&quot;</span>
    <span class="nl">with_dict:</span> <span class="s">&quot;{{users}}&quot;</span>
    <span class="err">#</span> <span class="n">msg</span><span class="o">:</span> <span class="s">&quot;User {{item.key}} is {{item.value.name}},Gender: {{item.value.gender}},Tel:{{item.value.telephone}}&quot;</span>
</pre></div>


<h3 id="with_file">with_file</h3>
<blockquote>
<p>获取ansible主机上的文件内容</p>
</blockquote>
<div class="hlcode"><pre><span class="o">---</span>
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">gather_facts:</span> <span class="n">no</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
     <span class="nl">msg:</span> <span class="s">&quot;{{ item }}&quot;</span>
    <span class="nl">with_file:</span>
    <span class="o">-</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">1</span>
    <span class="o">-</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">2</span>
</pre></div>


<h3 id="with_fileglob">with_fileglob</h3>
<blockquote>
<p>用来匹配文件名称，只能匹配目录中的文件，不能匹配目录中的目录</p>
</blockquote>
<div class="hlcode"><pre><span class="o">---</span>
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">gather_facts:</span> <span class="n">no</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
     <span class="nl">msg:</span> <span class="s">&quot;{{ item }}&quot;</span>
    <span class="nl">with_fileglob:</span>
    <span class="o">-</span> <span class="o">/</span><span class="n">data</span><span class="o">/*</span>
</pre></div>
  
</div>
    </div>
    <div id="footer">
      <div class="footer-left">
        <p>
        Copyright © 2019 Uxun.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
        Theme by <a href="https://github.com/tankywoo/yasimple_x2" target="_blank">YASimple_X2</a>.
        </p>
      </div> <!-- end footer-left -->
      <div class="footer-right">
        <p>Page Updated 2019-09-18 22:14:15</p>
      </div> <!-- end footer-right -->
    </div>

    
    

  </body>
</html>
<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/colorful.css">
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/style.css">
    <link rel="shortcut icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>ApbLoops - Uxun's WIKI</title>
    <meta name="keywords" content=""/>
    <meta name="description" content=""/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
  </head>

  <body>
    <div id="container" class="typo">
      
<div id="header">
  <div id="post-nav">
    <a href="/wiki/">Uxun's WIKI</a>
    &nbsp;&#187;&nbsp;
    <a href="/wiki/#ops">ops</a>
    &nbsp;&#187;&nbsp;ApbLoops
    <span class="updated">Page Updated&nbsp;
    
    </span>
  </div>
</div>
<div class="clearfix"></div>
<div id="content">
  <h1 id="ansible-playbook-loops">Ansible Playbook Loops</h1>
<table>
<thead>
<tr>
<th><strong>with_list</strong></th>
<th><strong>with_flattened</strong></th>
<th><strong>with_together</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>with_cartesian</strong></td>
<td><strong>with_indexed_items</strong></td>
<td><strong>with_flattened</strong></td>
</tr>
<tr>
<td><strong>with_sequence</strong></td>
<td><strong>with_random_choice</strong></td>
<td><strong>with_dict</strong></td>
</tr>
<tr>
<td><strong>with_file</strong></td>
<td><strong>with_fileglo</strong></td>
<td><strong>loop</strong></td>
</tr>
</tbody>
</table>
<p><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html#with-dict">REFERNECE</a></p>
<blockquote>
<p>循环处理返回信息,指定操作主机处理</p>
</blockquote>
<h3 id="with_items">with_items:</h3>
<blockquote>
<p>遍历数组</p>
<p>with_flattened: 同 with_items</p>
</blockquote>
<div class="hlcode"><pre><span class="o">---</span>
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">gather_facts:</span> <span class="n">no</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
      <span class="nl">msg:</span> <span class="s">&quot;{{ item }}&quot;</span>
    <span class="nl">with_items:</span> <span class="s">&quot;{{groups.etcd}}&quot;</span>

<span class="cp"># 格式</span>
<span class="cp"># one的值为a, etcd的值为1。输出为a,2</span>
<span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
   <span class="nl">msg:</span> <span class="s">&quot;{{ item.one}}&quot;</span>
  <span class="nl">with_items:</span>
  <span class="o">-</span> <span class="p">{</span> <span class="n">one</span><span class="o">:</span> <span class="n">a</span><span class="p">,</span> <span class="n">etcd</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span> <span class="n">one</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">etcd</span><span class="o">:</span> <span class="mi">3</span> <span class="p">}</span>

<span class="cp"># e.g</span>
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">vars:</span>
    <span class="nl">dirs:</span> <span class="p">[</span><span class="s">&quot;/data/a&quot;</span><span class="p">,</span><span class="s">&quot;/data/b&quot;</span><span class="p">]</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">file</span><span class="o">:</span>
     <span class="nl">path:</span> <span class="s">&quot;{{item}}&quot;</span>
     <span class="nl">state:</span> <span class="n">touch</span>
    <span class="nl">with_items:</span> <span class="s">&quot;{{dirs}}&quot;</span>

<span class="cp"># e.g register</span>
<span class="cp"># 返回值放入 results 序列中，可通过results关键字获取返回值</span>
<span class="o">---</span>
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">gather_facts:</span> <span class="n">no</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">shell</span><span class="o">:</span> <span class="s">&quot;{{item}}&quot;</span> 
    <span class="n">with_items</span><span class="o">:</span>
    <span class="o">-</span> <span class="s">&quot;ls /data&quot;</span>
    <span class="o">-</span> <span class="s">&quot;ls /root&quot;</span>
    <span class="nl">register:</span> <span class="n">rue</span>
  <span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
     <span class="nl">msg:</span> <span class="s">&quot;{{item.stdout}}&quot;</span>
    <span class="nl">with_items:</span> <span class="s">&quot;{{rue.results}}&quot;</span>
</pre></div>


<h3 id="with_list">with_list</h3>
<blockquote>
<p>将外层列作为一组输出</p>
</blockquote>
<div class="hlcode"><pre><span class="err">#</span> <span class="nt">e</span><span class="nc">.g</span> <span class="nt">with_list</span> <span class="err">将数组中作为</span><span class="nt">debug</span><span class="err">一个小整体输出</span>
<span class="nt">---</span>
<span class="nt">-</span> <span class="nt">hosts</span><span class="o">:</span> <span class="nt">one</span>
  <span class="nt">tasks</span><span class="o">:</span>
  <span class="nt">-</span> <span class="nt">debug</span><span class="o">:</span>
      <span class="nt">msg</span><span class="o">:</span> <span class="s2">&quot;{{item}}&quot;</span>
    <span class="nt">with_list</span><span class="o">:</span>
    <span class="nt">-</span> <span class="cp">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="cp">]</span>
    <span class="nt">-</span> <span class="cp">[</span><span class="nx">ha</span><span class="p">,</span><span class="nx">ah</span><span class="p">,</span><span class="nx">hah</span><span class="cp">]</span>
<span class="nt">TASK</span> <span class="cp">[</span><span class="nb">debug</span><span class="cp">]</span> <span class="o">******************************************************************************************************************************</span>
<span class="nt">ok</span><span class="o">:</span> <span class="cp">[</span><span class="mf">192.168.1.116</span><span class="cp">]</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="nt">item</span><span class="o">=</span><span class="cp">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="cp">]</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s2">&quot;msg&quot;</span><span class="o">:</span> <span class="cp">[</span>
        <span class="mi">1</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">,</span>
        <span class="mi">3</span>
    <span class="cp">]</span>
<span class="p">}</span>
<span class="nt">ok</span><span class="o">:</span> <span class="cp">[</span><span class="mf">192.168.1.116</span><span class="cp">]</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="nt">item</span><span class="o">=</span><span class="cp">[</span><span class="nx">u</span><span class="s1">&#39;ha&#39;</span><span class="p">,</span> <span class="nx">u</span><span class="s1">&#39;ah&#39;</span><span class="p">,</span> <span class="nx">u</span><span class="s1">&#39;hah&#39;</span><span class="cp">]</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s2">&quot;msg&quot;</span><span class="o">:</span> <span class="cp">[</span>
        <span class="s2">&quot;ha&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ah&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hah&quot;</span>
    <span class="cp">]</span>
<span class="p">}</span>
</pre></div>


<h3 id="with_together">with_together</h3>
<blockquote>
<p>将两个列表中的元素对齐合并</p>
</blockquote>
<div class="hlcode"><pre><span class="gd">--- </span>
<span class="gd">- hosts: one</span>
  remote_user: root
  gather_facts: no
  tasks:
  - debug:
     msg: &#39;{{item}}&#39;
    whit_together:
    - [a,b,c]
    - [d,e,f]

# The results of ad,bc,cf
</pre></div>


<h3 id="with_cartesian">with_cartesian</h3>
<blockquote>
<p>类似笛卡尔乘积，将列1中的元素与列2中的元素两两组合</p>
</blockquote>
<div class="hlcode"><pre><span class="cp"># e.g with_cartesian:</span>
<span class="o">---</span>
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">file</span><span class="o">:</span>
     <span class="nl">state:</span> <span class="n">directory</span>
     <span class="nl">path:</span> <span class="s">&quot;/data/{{item.0}}/{{item.1}}&quot;</span>
    <span class="nl">with_cartesian:</span>
    <span class="o">-</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
    <span class="o">-</span> <span class="p">[</span><span class="mf">4.5.6</span><span class="p">]</span>

<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">ap</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="mi">116</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">ls</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span>
<span class="mi">1</span>  <span class="mi">2</span>  <span class="mi">3</span> 
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">ap</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="mi">116</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">ls</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span>
<span class="mi">4</span><span class="o">/</span> <span class="mi">5</span><span class="o">/</span> <span class="mi">6</span><span class="o">/</span>

<span class="cp"># use loop </span>
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">gather_facts:</span> <span class="n">no</span>
  <span class="nl">vars:</span>
   <span class="nl">dir1:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
   <span class="nl">dir2:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
     <span class="nl">msg:</span> <span class="s">&quot;{{item.0}}--{{item.1}}&quot;</span>
    <span class="nl">loop:</span> <span class="s">&quot;{{dir1 | product(dir2)| list}}&quot;</span>
</pre></div>


<h3 id="with_indexed_items">with_indexed_items</h3>
<blockquote>
<p>循环处理列表时候为列表中每一项添加"数字索引，0开始计数" 多列表情况类似with_flattened</p>
</blockquote>
<div class="hlcode"><pre><span class="cp"># 数字索引，0开始计数</span>
<span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
   <span class="nl">msg:</span> <span class="err">&#39;</span><span class="p">{{</span><span class="n">item</span><span class="p">}}</span><span class="err">&#39;</span>
  <span class="nl">with_indexed_items:</span>
  <span class="o">-</span> <span class="n">a</span>
  <span class="o">-</span> <span class="n">b</span>
  <span class="o">-</span> <span class="n">c</span>

<span class="cp"># The results of 0a,1b,2c</span>
</pre></div>


<h3 id="with_sequence">with_sequence</h3>
<blockquote>
<p>指定模块循环 tip：format:指定数据输出的格式</p>
</blockquote>
<div class="hlcode"><pre><span class="cp"># e.g with_sequence 模块循环调用，通过sequence顺序生成数字序列 </span>
<span class="cp"># start=1开始 end=3结束 stride=1步长 同等于 count=3</span>
<span class="o">---</span> 
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
     <span class="nl">msg:</span> <span class="p">{{</span><span class="n">item</span><span class="p">}}</span>
    <span class="nl">with_sequence:</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span> <span class="n">end</span><span class="o">=</span><span class="mi">3</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span>
    <span class="err">#</span> <span class="n">with_sequence</span><span class="o">:</span> <span class="n">count</span><span class="o">=</span><span class="mi">3</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;number is %0.2f&quot;</span> <span class="o">%</span><span class="mf">0.2f</span><span class="o">:</span><span class="err">保留两位小数点的浮点数</span>
    <span class="err">#</span> <span class="n">with_sequence</span><span class="o">:</span> <span class="n">start</span><span class="o">=</span><span class="mi">6</span> <span class="n">end</span><span class="o">=</span><span class="mi">2</span> <span class="n">stride</span><span class="o">=-</span><span class="mi">2</span> <span class="err">数字</span><span class="mi">6</span><span class="err">开始，每次递减</span><span class="mi">2</span><span class="err">，到</span><span class="mi">2</span><span class="err">结束</span>

<span class="cp"># loop </span>
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">gather_facts:</span> <span class="n">no</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
     <span class="nl">msg:</span> <span class="s">&quot;{{item}}&quot;</span>
    <span class="nl">loop:</span> <span class="s">&quot;{{range(0,10,2)|list}}&quot;</span>
</pre></div>


<h3 id="with_random_choice">with_random_choice</h3>
<blockquote>
<p>列表中随机返回值</p>
</blockquote>
<div class="hlcode"><pre><span class="nl">tasks:</span>
<span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
   <span class="nl">msg:</span> <span class="err">&#39;</span><span class="p">{{</span><span class="n">item</span><span class="p">}}</span><span class="err">&#39;</span>
  <span class="nl">with_random_choice:</span>
  <span class="o">-</span> <span class="mi">1</span>
  <span class="o">-</span> <span class="mi">2</span>
  <span class="o">-</span> <span class="mi">3</span>

<span class="cp"># use loop</span>
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">gather_facts:</span> <span class="n">no</span>
  <span class="nl">vars:</span>
   <span class="nl">file1:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
     <span class="nl">msg:</span> <span class="s">&quot;{{file1|random}}&quot;</span>
</pre></div>


<h3 id="with_dict">with_dict</h3>
<blockquote>
<p>处理字典键值对</p>
</blockquote>
<div class="hlcode"><pre><span class="cp"># e.g with_dict key=tony value:name,gender,telephone</span>
<span class="o">---</span>
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">vars:</span>
   <span class="nl">users:</span>
     <span class="nl">tony:</span>
      <span class="nl">name:</span> <span class="n">sssxun</span>
      <span class="nl">gender:</span> <span class="n">female</span>
      <span class="nl">telephone:</span> <span class="mi">133</span>
     <span class="nl">cact:</span>
      <span class="nl">name:</span> <span class="n">zzzhong</span>
      <span class="nl">gender:</span> <span class="n">male</span>
      <span class="nl">telephone:</span> <span class="mi">122</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
     <span class="nl">msg:</span> <span class="s">&quot;{{item}}&quot;</span>
    <span class="nl">with_dict:</span> <span class="s">&quot;{{users}}&quot;</span>
    <span class="err">#</span> <span class="n">msg</span><span class="o">:</span> <span class="s">&quot;User {{item.key}} is {{item.value.name}},Gender: {{item.value.gender}},Tel:{{item.value.telephone}}&quot;</span>

<span class="cp"># use loop</span>
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">gather_facts:</span> <span class="n">no</span>
  <span class="nl">vars:</span>
   <span class="nl">tests:</span>
    <span class="nl">d:</span> <span class="n">no</span>
    <span class="nl">f:</span> <span class="n">done</span>
    <span class="nl">a:</span> <span class="n">hello</span>
    <span class="nl">b:</span> <span class="n">world</span>
    <span class="nl">e:</span> <span class="mi">666</span>
    <span class="nl">z:</span> <span class="n">test</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
     <span class="nl">msg:</span> <span class="s">&quot;{{item.key}}--{{item.value}}&quot;</span>
    <span class="nl">loop:</span> <span class="s">&quot;{{tests | dict2items}}&quot;</span>
  <span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
     <span class="nl">msg:</span> <span class="s">&quot;{{item.0}}--{{item.1}}&quot;</span>
    <span class="nl">loop:</span> <span class="s">&quot;{{tests | dictsort}}&quot;</span>
</pre></div>


<h3 id="with_file">with_file</h3>
<blockquote>
<p>获取ansible主机上的文件内容</p>
</blockquote>
<div class="hlcode"><pre><span class="o">---</span>
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">gather_facts:</span> <span class="n">no</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
     <span class="nl">msg:</span> <span class="s">&quot;{{ item }}&quot;</span>
    <span class="nl">with_file:</span>
    <span class="o">-</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">1</span>
    <span class="o">-</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">2</span>
</pre></div>


<h3 id="with_fileglob">with_fileglob</h3>
<blockquote>
<p>用来匹配文件名称，只能匹配目录中的文件，不能匹配目录中的目录</p>
</blockquote>
<div class="hlcode"><pre><span class="o">---</span>
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">gather_facts:</span> <span class="n">no</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
     <span class="nl">msg:</span> <span class="s">&quot;{{ item }}&quot;</span>
    <span class="nl">with_fileglob:</span>
    <span class="o">-</span> <span class="o">/</span><span class="n">data</span><span class="o">/*</span>
</pre></div>


<h3 id="loop">loop</h3>
<blockquote>
<p>lookup('插件名',数据)</p>
</blockquote>
<p>[official] ansible &gt; 2.6 推荐 loop + filter 方式操作循环</p>
<p>与with_indexed_items处理结果一样</p>
<div class="hlcode"><pre><span class="cp"># 用lookup插件处理列表</span>
<span class="o">---</span>
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">gather_facts:</span> <span class="n">no</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">debug</span><span class="o">:</span> 
     <span class="n">msg</span><span class="o">:</span> <span class="s">&quot;index is {{item.0}}, value is {{item.1}}&quot;</span>
    <span class="nl">loop:</span> <span class="s">&quot;{{lookup(&#39;indexed_items&#39;,[&#39;a&#39;,&#39;b&#39;,&#39;c&#39;])}}&quot;</span>
</pre></div>


<p>插件使用</p>
<div class="hlcode"><pre><span class="cp"># 可用插件</span>
<span class="n">ansible</span><span class="o">-</span><span class="n">doc</span> <span class="o">-</span><span class="n">t</span> <span class="n">lookup</span> <span class="o">-</span><span class="n">l</span>

<span class="cp"># 详细用法</span>
<span class="n">ansible</span><span class="o">-</span><span class="n">doc</span> <span class="o">-</span><span class="n">t</span> <span class="n">lookup</span> <span class="n">dict</span>
</pre></div>


<p><strong>e.g</strong></p>
<div class="hlcode"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span>
   <span class="l-Scalar-Plain">msg</span><span class="p-Indicator">:</span> <span class="s">&quot;{{lookup(&#39;file&#39;,&#39;/data/testfiel&#39;,errors=&#39;ignore&#39;)}}&quot;</span>
</pre></div>


<p><strong>json_query</strong></p>
<div class="hlcode"><pre><span class="cp"># https:</span><span class="c1">//docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html#json-query-filter</span>

<span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="s">&quot;Display all cluster names&quot;</span>
  <span class="nl">debug:</span>
    <span class="nl">var:</span> <span class="n">item</span>
  <span class="nl">loop:</span> <span class="s">&quot;{{ domain_definition | json_query(&#39;domain.cluster[*].name&#39;) }}&quot;</span>
</pre></div>


<h3 id="loop_control"><strong>loop_control</strong></h3>
<blockquote>
<p>控制循环的行为</p>
</blockquote>
<p><strong>pause</strong></p>
<div class="hlcode"><pre><span class="cp"># 控制每次循环后的暂停时间</span>
<span class="o">---</span>
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">gather_facts:</span> <span class="n">no</span>
  <span class="nl">tasks:</span> 
  <span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
     <span class="nl">msg:</span> <span class="s">&quot;{{itme}}&quot;</span>
    <span class="nl">loop:</span>
    <span class="o">-</span> <span class="mi">1</span>
    <span class="o">-</span> <span class="mi">2</span>
    <span class="o">-</span> <span class="mi">3</span>
    <span class="nl">loop_control:</span>
     <span class="nl">pause:</span> <span class="mi">10</span>
</pre></div>


<p><strong>label</strong></p>
<div class="hlcode"><pre><span class="cp"># 简化只需要的输出</span>
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">gather_facts:</span> <span class="n">no</span>
  <span class="nl">vars:</span>
   <span class="nl">tests:</span>
    <span class="nl">d:</span> <span class="n">no</span>
    <span class="nl">f:</span> <span class="n">done</span>
    <span class="nl">a:</span> <span class="n">hello</span>
    <span class="nl">b:</span> <span class="n">world</span>
    <span class="nl">e:</span> <span class="mi">666</span>
    <span class="nl">z:</span> <span class="n">test</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
     <span class="nl">msg:</span> <span class="s">&quot;{{item.key}}--{{item.value}}&quot;</span>
    <span class="nl">loop:</span> <span class="s">&quot;{{tests | dict2items}}&quot;</span>
    <span class="nl">loop_control:</span>
     <span class="nl">label:</span> <span class="s">&quot;{{item.key}}&quot;</span>

<span class="n">TASK</span> <span class="p">[</span><span class="n">debug</span><span class="p">]</span> <span class="o">**************************************************************************************************</span>
<span class="nl">ok:</span> <span class="p">[</span><span class="mf">192.168.0.23</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">a</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s">&quot;msg&quot;</span><span class="o">:</span> <span class="s">&quot;a--hello&quot;</span>
<span class="p">}</span>
<span class="nl">ok:</span> <span class="p">[</span><span class="mf">192.168.0.23</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s">&quot;msg&quot;</span><span class="o">:</span> <span class="s">&quot;b--world&quot;</span>
<span class="p">}</span>
</pre></div>


<p><strong>loop_var</strong></p>
<blockquote>
<p>循环嵌套</p>
</blockquote>
<div class="hlcode"><pre><span class="cp"># main.yml</span>
<span class="o">-</span> <span class="n">hosts</span><span class="o">:</span> <span class="n">one</span>
  <span class="nl">remote_user:</span> <span class="n">root</span>
  <span class="nl">gather_facts:</span> <span class="n">no</span>
  <span class="nl">tasks:</span>
  <span class="o">-</span> <span class="n">include_tasks</span><span class="o">:</span> <span class="n">inner</span><span class="p">.</span><span class="n">yml</span>
    <span class="nl">loop:</span>
     <span class="o">-</span> <span class="mi">1</span>
     <span class="o">-</span> <span class="mi">2</span>
     <span class="o">-</span> <span class="mi">3</span>
    <span class="nl">loop_control:</span>
     <span class="nl">loop_var:</span> <span class="n">outer_item</span>

<span class="cp"># inner.yml</span>
<span class="o">-</span> <span class="n">debug</span><span class="o">:</span>
    <span class="nl">msg:</span> <span class="s">&quot;outer item={{ outer_item }} inner item={{ item }}&quot;</span>
  <span class="nl">loop:</span>
    <span class="o">-</span> <span class="n">a</span>
    <span class="o">-</span> <span class="n">b</span>
    <span class="o">-</span> <span class="n">c</span>

<span class="n">TASK</span> <span class="p">[</span><span class="n">include_tasks</span><span class="p">]</span> <span class="o">******************************************************************************************</span>
<span class="nl">included:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">inner</span><span class="p">.</span><span class="n">yml</span> <span class="k">for</span> <span class="mf">192.168.0.23</span>
<span class="nl">included:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">inner</span><span class="p">.</span><span class="n">yml</span> <span class="k">for</span> <span class="mf">192.168.0.23</span>
<span class="nl">included:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">inner</span><span class="p">.</span><span class="n">yml</span> <span class="k">for</span> <span class="mf">192.168.0.23</span>

<span class="n">TASK</span> <span class="p">[</span><span class="n">debug</span><span class="p">]</span> <span class="o">**************************************************************************************************</span>
<span class="nl">ok:</span> <span class="p">[</span><span class="mf">192.168.0.23</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">a</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s">&quot;msg&quot;</span><span class="o">:</span> <span class="s">&quot;outer item=1 inner item=a&quot;</span>
<span class="p">}</span>
<span class="nl">ok:</span> <span class="p">[</span><span class="mf">192.168.0.23</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s">&quot;msg&quot;</span><span class="o">:</span> <span class="s">&quot;outer item=1 inner item=b&quot;</span>
<span class="p">}</span>
<span class="nl">ok:</span> <span class="p">[</span><span class="mf">192.168.0.23</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">c</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s">&quot;msg&quot;</span><span class="o">:</span> <span class="s">&quot;outer item=1 inner item=c&quot;</span>
<span class="p">}</span>

<span class="n">TASK</span> <span class="p">[</span><span class="n">debug</span><span class="p">]</span> <span class="o">**************************************************************************************************</span>
<span class="nl">ok:</span> <span class="p">[</span><span class="mf">192.168.0.23</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">a</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s">&quot;msg&quot;</span><span class="o">:</span> <span class="s">&quot;outer item=2 inner item=a&quot;</span>
<span class="p">}</span>
<span class="nl">ok:</span> <span class="p">[</span><span class="mf">192.168.0.23</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s">&quot;msg&quot;</span><span class="o">:</span> <span class="s">&quot;outer item=2 inner item=b&quot;</span>
<span class="p">}</span>
<span class="nl">ok:</span> <span class="p">[</span><span class="mf">192.168.0.23</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">c</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s">&quot;msg&quot;</span><span class="o">:</span> <span class="s">&quot;outer item=2 inner item=c&quot;</span>
<span class="p">}</span>
</pre></div>


<p><strong>内置特殊变量</strong></p>
<div class="hlcode"><pre><span class="n">loop</span><span class="p">.</span><span class="n">index</span>   <span class="err">当前循环操作为整个循环的第几次循环，序号从</span><span class="mi">1</span><span class="err">开始</span>
<span class="n">loop</span><span class="p">.</span><span class="n">index0</span>   <span class="err">当前循环操作为整个循环的第几次循环，序号从</span><span class="mi">0</span><span class="err">开始</span>
<span class="n">loop</span><span class="p">.</span><span class="n">revindex</span>  <span class="err">当前循环操作距离整个循环结束还有几次，序号到</span><span class="mi">1</span><span class="err">结束</span>
<span class="n">loop</span><span class="p">.</span><span class="n">revindex0</span> <span class="err">当前循环操作距离整个循环结束还有几次，序号到</span><span class="mi">0</span><span class="err">结束</span>
<span class="n">loop</span><span class="p">.</span><span class="n">first</span>    <span class="err">当操作可迭代对象中的第一个元素时，此变量的值为</span><span class="nb">true</span>
<span class="n">loop</span><span class="p">.</span><span class="n">last</span>    <span class="err">当操作可迭代对象中的最后一个元素时，此变量的值为</span><span class="nb">true</span>
<span class="n">loop</span><span class="p">.</span><span class="n">length</span>   <span class="err">可迭代对象的长度</span>
<span class="n">loop</span><span class="p">.</span><span class="n">depth</span>   <span class="err">当使用递归的循环时，当前迭代所在的递归中的层级，层级序号从</span><span class="mi">1</span><span class="err">开始</span>
<span class="n">loop</span><span class="p">.</span><span class="n">depth0</span>   <span class="err">当使用递归的循环时，当前迭代所在的递归中的层级，层级序号从</span><span class="mi">0</span><span class="err">开始</span>
<span class="n">loop</span><span class="p">.</span><span class="n">cycle</span><span class="p">()</span>  <span class="err">这是一个辅助函数，通过这个函数我们可以在指定的一些值中进行轮询取值，具体参考之后的示例</span>
</pre></div>
  
</div>
    </div>
    <div id="footer">
      <div class="footer-left">
        <p>
        Copyright © 2019 Uxun.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
        Theme by <a href="https://github.com/tankywoo/yasimple_x2" target="_blank">YASimple_X2</a>.
        </p>
      </div> <!-- end footer-left -->
      <div class="footer-right">
        <p>Page Updated 2019-09-30 14:39:58</p>
      </div> <!-- end footer-right -->
    </div>

    
    

  </body>
</html>
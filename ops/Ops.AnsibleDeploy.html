<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/colorful.css">
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/style.css">
    <link rel="shortcut icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>AnsibleDeploy - Uxun's WIKI</title>
    <meta name="keywords" content=""/>
    <meta name="description" content=""/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
  </head>

  <body>
    <div id="container" class="typo">
      
<div id="header">
  <div id="post-nav">
    <a href="/wiki/">Uxun's WIKI</a>
    &nbsp;&#187;&nbsp;
    <a href="/wiki/#ops">ops</a>
    &nbsp;&#187;&nbsp;AnsibleDeploy
    <span class="updated">Page Updated&nbsp;
    
    </span>
  </div>
</div>
<div class="clearfix"></div>
<div id="content">
  <h1 id="ansible-deploy">Ansible Deploy</h1>
<h3 id="1install">1.Install</h3>
<blockquote>
<p>version 2.6.12 支持 "-" 符号</p>
</blockquote>
<p><strong>Yum install</strong> <a href="https://fedoraproject.org/wiki/EPEL">epel</a></p>
<div class="hlcode"><pre><span class="cp">#epel 6</span>
<span class="n">yum</span> <span class="n">install</span> <span class="n">https</span><span class="o">:</span><span class="c1">//dl.fedoraproject.org/pub/epel/epel-release-latest-6.noarch.rpm</span>
<span class="cp">#epel 7</span>
<span class="n">yum</span> <span class="n">install</span> <span class="n">https</span><span class="o">:</span><span class="c1">//dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</span>
<span class="cp"># yum makecache</span>
<span class="n">yum</span> <span class="n">install</span> <span class="n">ansible</span>
</pre></div>


<p><strong>Pip install</strong> </p>
<div class="hlcode"><pre><span class="cp"># pip install ansible</span>
<span class="n">yum</span> <span class="n">install</span> <span class="n">epel</span><span class="o">-</span><span class="n">release</span> <span class="o">-</span><span class="n">y</span>
<span class="cp"># install Depend on the tool</span>
<span class="n">yum</span> <span class="n">install</span> <span class="n">git</span> <span class="n">python</span> <span class="n">python</span><span class="o">-</span><span class="n">pip</span> <span class="n">expect</span> <span class="o">-</span><span class="n">y</span>

<span class="n">pip</span> <span class="n">install</span> <span class="n">pip</span> <span class="o">--</span><span class="n">upgrade</span> <span class="o">-</span><span class="n">i</span> <span class="n">http</span><span class="o">:</span><span class="c1">//mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com</span>

<span class="n">pip</span> <span class="n">install</span> <span class="n">ansible</span><span class="o">==</span><span class="mf">2.6.12</span> <span class="o">-</span><span class="n">i</span> <span class="n">http</span><span class="o">:</span><span class="c1">//mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com</span>
</pre></div>


<h3 id="2configuration">2.Configuration</h3>
<blockquote>
<p>/etc/ansible/ansible.cfg</p>
<p>关闭 host_key_checking = False   or  通过env $ export ANSIBLE_HOST_KEY_CHECKING=False</p>
</blockquote>
<div class="hlcode"><pre><span class="p">[</span><span class="n">defaults</span><span class="p">]</span>  
<span class="cp"># inventory = /etc/ansible/hosts        # 定义Inventory  </span>
<span class="cp"># library = /usr/share/my_modules/      # 自定义lib库存放目录  </span>
<span class="cp"># remote_tmp = $HOME/.ansible/tmp       # 临时文件远程主机存放目录  </span>
<span class="cp"># local_tmp = $HOME/.ansible/tmp        # 临时文件本地存放目录  </span>
<span class="cp"># forks = 5                             # 默认开启的并发数  </span>
<span class="cp"># poll_interval = 15                    # 默认轮询时间间隔  </span>
<span class="cp"># sudo_user  = root                     # 默认sudo用户  </span>
<span class="cp"># ask_sudo_pass = True                  # 是否需要sudo密码  </span>
<span class="cp"># ask_pass  = True                      # 是否需要密码  </span>
<span class="cp"># roles_path = /etc/ansible/roles       # 默认下载的Roles存放的目录  </span>
<span class="cp"># host_key_checking = False             # 首次连接是否需要检查key认证，建议设为False  </span>
<span class="cp"># timeout = 10                          # 默认超时时间  </span>
<span class="cp"># timeout = 10                          # 如没有指定用户，默认使用的远程连接用户  </span>
<span class="cp"># log_path = /var/log/ansible.log       # 执行日志存放目录  </span>
<span class="cp"># module_name = command                 # 默认执行的模块  </span>
<span class="cp"># action_plugins = /usr/share/ansible/plugins/action     # action插件的存放目录  </span>
<span class="cp"># callback_plugins = /usr/share/ansible/plugins/callback # callback插件的存放目录  </span>
<span class="cp"># connection_plugins = /usr/share/ansible/plugins/connection    # connection插件的存放目录  </span>
<span class="cp"># lookup_plugins = /usr/share/ansible/plugins/lookup     # lookup插件的存放目录  </span>
<span class="cp"># vars_plugins = /usr/share/ansible/plugins/vars         # vars插件的存放目录  </span>
<span class="cp"># filter_plugins = /usr/share/ansible/plugins/filter     # filter插件的存放目录  </span>
<span class="cp"># test_plugins = /usr/share/ansible/plugins/test         # test插件的存放目录  </span>
<span class="cp"># strategy_plugins = /usr/share/ansible/plugins/strategy # strategy插件的存放目录  </span>
<span class="cp"># fact_caching = memory                      # getfact缓存的主机信息存放方式  </span>
<span class="cp"># retry_files_enabled = False </span>
<span class="cp"># retry_files_save_path = ~/.ansible-retry   # 错误重启文件存放目录</span>
</pre></div>


<h3 id="3hosts-eg-inventory">3.Hosts e.g <a href="https://docs.ansible.com/ansible/2.4/intro_inventory.html">Inventory</a></h3>
<blockquote>
<p>ansible中只能用空格缩进</p>
<p>children: 表示C组中包含子组，为A组和B组，</p>
</blockquote>
<div class="hlcode"><pre><span class="cp"># INI格式</span>
<span class="p">[</span><span class="n">A</span><span class="p">]</span>
<span class="mf">10.0.0.10</span>
<span class="p">[</span><span class="n">B</span><span class="p">]</span>
<span class="mf">10.0.0.20</span>
<span class="mf">10.0.0.30</span>

<span class="p">[</span><span class="n">C</span><span class="o">:</span><span class="n">children</span><span class="p">]</span>
<span class="n">A</span>
<span class="n">B</span>
<span class="cp"># YAML格式</span>
<span class="nl">all:</span>
  <span class="nl">children:</span>
    <span class="nl">C:</span>
      <span class="nl">children:</span>
        <span class="nl">A:</span>
          <span class="nl">hosts:</span>
            <span class="mf">10.0.0.10</span><span class="o">:</span>
        <span class="nl">B:</span>
          <span class="nl">hosts:</span>
            <span class="mf">10.0.0.20</span><span class="o">:</span>
            <span class="mf">10.0.0.30</span><span class="o">:</span>
</pre></div>


<h3 id="4authorized_key">4.authorized_key</h3>
<p>playbook push <a href="https://docs.ansible.com/ansible/latest/modules/authorized_key_module.html">official</a></p>
<div class="hlcode"><pre><span class="c1"># ansible(2.4) hosts example：</span>
<span class="p-Indicator">[</span><span class="nv">xun_servers</span><span class="p-Indicator">]</span>
<span class="l-Scalar-Plain">192.168.1.1 ansible_user=xun ansible_port=10022 ansible_ssh_pass=&quot;test&quot;</span>
<span class="l-Scalar-Plain">192.168.1.2 ansible_user=xun  ansible_port=22 ansible_ssh_pass=&quot;test&quot;</span>
<span class="l-Scalar-Plain"># -----------------------------------------------------------</span>
<span class="l-Scalar-Plain">$ ansible-playbook ssh-copy-id.yaml -f 8 (并发数)</span>
<span class="l-Scalar-Plain"># Using alternate directory locations</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">xun_servers</span>
    <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">xun</span>
    <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
     <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ssh-copy</span>
       <span class="l-Scalar-Plain">authorized_key</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">user=xun key=&quot;{{ lookup(&#39;file&#39;, &#39;/home/xun/.ssh/id_rsa.pub }}&quot;</span>
       <span class="l-Scalar-Plain">tags</span><span class="p-Indicator">:</span>
         <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sshkey</span>
</pre></div>


<h3 id="refernece">REFERNECE</h3>
<p><a href="https://github.com/ansible/ansible">official</a></p>
<p><a href="https://ansible-tran.readthedocs.io/en/latest/docs/intro_installation.html">DOCS</a></p>
<h1 id="intro">Intro</h1>
<blockquote>
<p>基于Python开发，集合了众多运维工具（puppet、cfengine、chef、func、fabric）的优点，实现了批量系统配置、批量程序部署、批量运行命令等功能。ansible是基于模块工作的，本身没有批量部署的能力。<strong>真正具有批量部署的是ansible所运行的模块，ansible只是提供一种框架。</strong></p>
</blockquote>
<div class="hlcode"><pre><span class="err">主要包括：</span>
<span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="err">连接插件</span><span class="n">connection</span> <span class="n">plugins</span><span class="err">：负责和被监控端实现通信；</span>
<span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="n">host</span> <span class="n">inventory</span><span class="err">：指定操作的主机，是一个配置文件里面定义监控的主机；</span>
<span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="err">各种模块核心模块、</span><span class="n">command</span><span class="err">模块、自定义模块；</span>
<span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="err">借助于插件完成记录日志邮件等功能；</span>
<span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="n">playbook</span><span class="err">：剧本执行多个任务时，非必需可以让节点一次性运行多个任务。</span>
</pre></div>


<p>如何工作</p>
<p>Ansible默认是通过SSH通道来管理的，也就是它所说的免客户端方式管理， 它底层是通过 paramiko （python库-连接插件并行的基于ssh连接）来实现的。   </p>
<p>对Ansible底层工作机制感兴趣的可以参考这个：http://www.the5fire.com/explore-the-ansible.html</p>
<h3 id="ansible-concept">Ansible Concept</h3>
<p><strong>特点：</strong></p>
<div class="hlcode"><pre><span class="mf">1.</span> <span class="err">高度模块化</span><span class="p">,</span><span class="err">调用特定的模块</span><span class="p">,</span><span class="err">完成特定的任务</span><span class="p">;</span>
<span class="mf">2.</span> <span class="err">基于</span><span class="n">Python</span><span class="err">语言实现</span><span class="p">,</span><span class="err">有</span><span class="n">Paramiko</span><span class="p">(</span><span class="err">模块</span><span class="o">-</span><span class="n">ssh</span><span class="err">的</span><span class="n">API</span><span class="p">).</span><span class="n">PyYAML</span><span class="p">(</span><span class="err">编排剧本的</span><span class="o">--</span><span class="err">模板语言</span><span class="p">)</span><span class="err">和</span><span class="n">Jinja2</span><span class="p">(</span><span class="err">模板语言</span><span class="o">--</span><span class="err">开发</span><span class="n">YAML</span><span class="err">格式</span><span class="p">)</span>
<span class="mf">3.</span> <span class="err">部署简单</span><span class="p">,</span><span class="n">agentless</span>
<span class="mf">4.</span> <span class="err">支持主从模式</span>
<span class="mf">5.</span> <span class="err">支持自定义模块</span>
<span class="mf">6.</span> <span class="err">支持</span><span class="n">Playbook</span>
<span class="mf">7.</span> <span class="err">支持幂等性（允许重复</span><span class="n">N</span><span class="err">次）</span>
</pre></div>


<p><strong>优点：</strong></p>
<div class="hlcode"><pre><span class="mf">1.</span> <span class="err">轻量级，他不需要去客户端安装</span><span class="n">agent</span><span class="err">，更新时，只需要在操作机上进行一次更新即可</span>
<span class="mf">2.</span> <span class="err">批量任务执行可以写成脚本，而且不用分发到远程就可以执行</span>
<span class="mf">3.</span> <span class="err">使用</span><span class="n">python</span><span class="err">编写的，维护更简单</span>
<span class="mf">4.</span> <span class="err">支持</span><span class="n">sudo</span>
</pre></div>


<p><strong>缺点：</strong></p>
<p>对于几千台、上万台机器的操作，还不清楚性能、效率情况如何，需要进一步了解</p>
<p><strong>核心组件：</strong></p>
<div class="hlcode"><pre><span class="mf">1.</span> <span class="n">ansible</span> <span class="n">core</span>
<span class="mf">2.</span> <span class="n">host</span> <span class="n">ivenetory</span><span class="p">(</span><span class="err">清单</span><span class="p">)</span>
<span class="mf">3.</span> <span class="n">core</span> <span class="n">modules</span>
<span class="mf">4.</span> <span class="n">cutom</span> <span class="n">modules</span>
<span class="mf">5.</span> <span class="n">playbook</span> <span class="p">(</span><span class="n">yml</span><span class="err">，</span><span class="n">jinjia2</span><span class="p">)</span>
<span class="mf">6.</span> <span class="n">connect</span> <span class="n">plugin</span><span class="err">（连接插件）</span>
</pre></div>


<p><strong>其他组件</strong></p>
<div class="hlcode"><pre><span class="err">#</span> <span class="nx">模块文档查看器</span><span class="err">，</span><span class="nx">很有用</span><span class="err">，</span><span class="nx">使用ansible</span> <span class="na">-l</span> <span class="nx">显示所有module列表</span><span class="err">，</span><span class="nx">使用</span> <span class="nx">ansible</span><span class="na">-doc</span>  <span class="o">&lt;</span><span class="nx">module_x</span><span class="o">&gt;</span> <span class="nx">来查看module_x的详细文档</span><span class="err">，</span><span class="nx">这里不做太多介绍</span>
<span class="p">/</span><span class="nx">usr</span><span class="p">/</span><span class="nx">bin</span><span class="p">/</span><span class="nx">ansible</span><span class="na">-doc</span>

<span class="err">#</span> <span class="nx">传说中的配置管理工具</span><span class="err">，</span><span class="nx">如果你用过puppet或者saltstack</span><span class="err">，</span><span class="nx">这个可以不用介绍了</span><span class="err">，</span><span class="nx">如果你没用过</span><span class="err">，</span><span class="nx">也没关系</span><span class="err">，</span><span class="nx">花费20分钟看下官方的Video</span><span class="err">。</span> 
<span class="p">/</span><span class="nx">usr</span><span class="p">/</span><span class="nx">bin</span><span class="p">/</span><span class="nx">ansible</span><span class="na">-galaxy</span>        

<span class="err">#</span> <span class="nx">ansible的pip</span><span class="err">，</span><span class="nx">可以从galaxy.ansible.com下载官方收录的playbooks</span>
<span class="p">/</span><span class="nx">usr</span><span class="p">/</span><span class="nx">bin</span><span class="p">/</span><span class="nx">ansible</span><span class="na">-playbook</span>

<span class="err">#</span> <span class="nx">支持直接从git下载playbook执行</span><span class="err">，</span><span class="nx">需要遵循其规定的目录格式</span><span class="err">，</span><span class="nx">用处不是特别大</span><span class="err">，</span><span class="nx">可以不关注</span>
<span class="p">/</span><span class="nx">usr</span><span class="p">/</span><span class="nx">bin</span><span class="p">/</span><span class="nx">ansible</span><span class="na">-pull</span>

<span class="err">#</span> <span class="nx">如果你的配置文件中含有敏感信息</span><span class="err">，</span><span class="nx">你可能并不希望他能被人看到</span><span class="err">，</span><span class="nx">vault可以帮你加密</span><span class="p">/</span><span class="nx">解密这个配置文件</span><span class="err">，</span><span class="nx">高级用法</span><span class="err">，</span><span class="nx">请参照http</span><span class="p">:</span><span class="c1">//blog.ansibleworks.com/2014/02/19/ansible-vault/</span>
<span class="p">/</span><span class="nx">usr</span><span class="p">/</span><span class="nx">bin</span><span class="p">/</span><span class="nx">ansible</span><span class="na">-vault</span>         
</pre></div>
  
</div>
    </div>
    <div id="footer">
      <div class="footer-left">
        <p>
        Copyright © 2019 Uxun.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
        Theme by <a href="https://github.com/tankywoo/yasimple_x2" target="_blank">YASimple_X2</a>.
        </p>
      </div> <!-- end footer-left -->
      <div class="footer-right">
        <p>Page Updated 2019-09-18 22:14:15</p>
      </div> <!-- end footer-right -->
    </div>

    
    

  </body>
</html>